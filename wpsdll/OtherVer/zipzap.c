
/*
 *  This file was generated by the SOM Compiler and Emitter Framework.
 *  Generated using:
 *      SOM Emitter emitctm: 2.42i */

#ifndef SOM_Module_zipzap_Source
#define SOM_Module_zipzap_Source
#endif
#define zipzapfile_Class_Source
#define M_zipzapfile_Class_Source


#define ZZMAXPATH     1024
#define MINZIPSIZE       22
#define ZZSTACKSIZE   65536

#include "zipzap.ih"



VOID msgBox(HWND hwnd, CHAR *title, CHAR *message);
INT msgBoxOKCANCEL(HWND hwndDlg, CHAR *title, CHAR *msg);
VOID msgOK(CHAR *title, CHAR *message);
VOID debugMsgCH(CHAR ch, CHAR *varName);
VOID debugMsgStr(CHAR *str, CHAR *varName);
VOID debugMsgULong(ULONG num, CHAR *varName);
VOID debugMsgInt(INT num, CHAR *varName);
INT chkValidDPStr(CHAR *dstr);
VOID saveZZSet(VOID);
VOID queryZZSet(VOID);
HOBJECT makeShadow(CHAR *pathS, CHAR *fold);
INT makeFolders(CHAR *pathStr);
INT strndel(CHAR *s, INT n);
MRESULT EXPENTRY ZipZapSettingsProc(HWND hwndDlg, ULONG msg,
                                                     MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY findProc(HWND hwndDlg, ULONG msg,
                                          MPARAM mp1, MPARAM mp2 );
BOOL FindFile(HWND hwndWnd, CHAR *fullFileName);
INT addDroppedFILES(CHAR *cmdParms, CHAR *zipFile, CHAR *droppedFiles, BOOL truncate);
LONG existFile(CHAR *fileStr);
INT setCMDFileName(CHAR *fqfname, CHAR *fname);
BOOL setConMenu( HWND hmenu, USHORT msg);
MRESULT EXPENTRY ztProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY zfolProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY uzmProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY uzexeProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY drpProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY cuzexeProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY cztProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY cuztProc(HWND hwndDlg, ULONG msg,
                                          MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY additionalProc(HWND hwndDlg, ULONG msg,
                                                  MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY aboutProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY createNewProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY contviewProc(HWND hwndDlg, ULONG msg,
                                                 MPARAM mp1, MPARAM mp2 );
MRESULT EXPENTRY newContProc(HWND hwndWnd, ULONG ulMsg,
                                                 MPARAM mp1, MPARAM mp2);
VOID _Optlink zzSettingsPage(PVOID n);
VOID _Optlink createNewDlg(PVOID n);
VOID _Optlink aboutDlg(PVOID n);
VOID _Optlink viewZipOnDClick(PVOID vobj);
INT getAppType(CHAR *appName);
VOID getINIFQNAME(VOID);
INT chkreg(VOID);
INT setINI(VOID);
VOID _Optlink payUp(PVOID n);
VOID _Optlink setINITH(PVOID n);
VOID _Optlink noFiles(PVOID n);
VOID _Optlink noBytes(PVOID n);
INT insertCont(HWND hwndDlg, CHAR *fname, CHAR *zname);
void strdelc(char *s, char c);
INT viewOnContDClick(HWND hwndF, CHAR *fn, CHAR *zn, CHAR *foldn, INT level);
INT insertContX(HWND hwndDlg, CHAR *fname, CHAR *zname, INT level);



typedef struct _MAIN_1000_REC 
   {
   MINIRECORDCORE Record;
   } MAIN_1000_REC;
   
typedef MAIN_1000_REC * PMAIN_1000_REC;


HMODULE hResource;
CHAR DTOP[ZZMAXPATH];
ULONG dtopsize = sizeof(DTOP);
CHAR ZZINIFN[] = "ZIPZAP.INI";
CHAR ZZINI[ZZMAXPATH];
INT pgmData[60];
HPOINTER hptr;

CHAR DSTR[ZZMAXPATH];
CHAR ZDSTR[ZZMAXPATH];
CHAR CZDSTR[ZZMAXPATH];
CHAR ZDSTRP[ZZMAXPATH];
CHAR DFSTR[ZZMAXPATH];
CHAR CDFSTR[ZZMAXPATH];
CHAR DFAULTDESTZ[ZZMAXPATH];
CHAR DFAULTDESTF[ZZMAXPATH];
CHAR nzShowCEdit[ZZMAXPATH];
CHAR nzExtZipView[ZZMAXPATH];
CHAR ZIPICON[ZZMAXPATH];
CHAR loaddskfARGS[60];
CHAR xdfcopyARGS[60];
CHAR unpackARGS[60];
CHAR argsUPP[60];
CHAR defdestUPP[ZZMAXPATH];
CHAR defdestUP[ZZMAXPATH];
CHAR defdestMDIMG[ZZMAXPATH];
CHAR xdfcopyargsMDIMG[60];
CHAR makedskfargsMDIMG[60];
CHAR defeditorUPS[ZZMAXPATH];
CHAR UNZIPARGS[60];
CHAR zipArgs[60];
CHAR CUNZIPARGS[60];
CHAR czipArgs[60];
BOOL ZTINPROGRESS;
BOOL UZMINPROGRESS;
BOOL UZEXEINPROGRESS;
BOOL ZFOLINPROGRESS;
BOOL DRPINPROGRESS;
CHAR noeas[5];
BOOL USECUSTOMZT;
BOOL USECUSTOMUZT;
HWND hwndZT;
HWND hwndZFOL;
HWND hwndUZM;
HWND hwndUZEXE;
HWND hwndDRP;
CHAR EXEZIP[ZZMAXPATH];
CHAR nzShowCEdit[ZZMAXPATH];
CHAR nzExtZipView[ZZMAXPATH];
INT setfnum;
CHAR defZipFile[ZZMAXPATH];
CHAR PROMPTINI[ZZMAXPATH];
CHAR PROMPTINIFN[ZZMAXPATH];
CHAR sprc[ZZMAXPATH];
CHAR sprcTMP[ZZMAXPATH];
ULONG TUSE;
CHAR INSTALLDIR[ZZMAXPATH];
CHAR ZIPZAPINI[ZZMAXPATH];
CHAR ZIPZAPINIFN[ZZMAXPATH];
ULONG progdrvNum;
CHAR progPath[ZZMAXPATH];
BOOL  CHECKMOD;
HWND hwndHelp;
HELPINIT hinit;
UINT OPENONCE;
USHORT mmbheight, borderwidth;
USHORT hsbwidth, vsbwidth;
HPOINTER oldPointer, newPointer;
BOOL CONTBUSY;
PFNWP oldContWinProc, oldContProc;
CHAR TFNAME[ZZMAXPATH];
CHAR ZIPNAME[ZZMAXPATH];
CHAR FOLDNAME[ZZMAXPATH];
INT lastlevelnum;
CHAR foldicon[ZZMAXPATH];
CHAR zipicon[ZZMAXPATH];
CHAR exeicon[ZZMAXPATH];
CHAR fileicon[ZZMAXPATH];











/*
SOM_Scope BOOL  SOMLINK zipzapfileX_wpModifyPopupMenu(zipzapfile *somSelf,
                                                      HWND hwndMenu,
                                                      HWND hwndCnr,
                                                      ULONG iPosition)
{
    CHAR rPath[ZZMAXPATH];
    ULONG rsize = sizeof(rPath);


    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpModifyPopupMenu");

    zipzapfile_parent_WPDataFile_wpModifyPopupMenu(somSelf,
                                                                       hwndMenu,
                                                                       hwndCnr,
                                                                       iPosition);
     
    // setINI();
    _wpRefresh(somSelf, 0, 0);

    if( pgmData[24] && pgmData[47] == 1 )
       {
       _wpQueryRealName(somSelf, rPath, &rsize, TRUE);
       if( strlen(rPath) > 4 )
          {
          if( strcmpi(rPath + (strlen(rPath) - 4), ".ZIP") == 0 )
             {
             _wpInsertPopupMenuItems(somSelf,
                                                  hwndMenu,
                                                  0,
                                                  hResource,
                                                  IDM_ZIPZAP_VIEWZIP,
                                                  WPMENUID_PRIMARY);
             }
          }
       }

    if( pgmData[1] )
       {
       _wpQueryRealName(somSelf, rPath, &rsize, TRUE);
       if( strlen(rPath) > 4 )
          {
          if( strcmpi(rPath + (strlen(rPath) - 4), ".ZIP") == 0 )
             {
             _wpInsertPopupMenuItems(somSelf,
                                                  hwndMenu,
                                                  0,
                                                  hResource,
                                                  IDM_ZIPZAP_UNZIPFILE,
                                                  WPMENUID_PRIMARY);
             setConMenu(hwndMenu, IDM_ZIPZAP_UNZIPME);
             }
          if( strcmpi(rPath + (strlen(rPath) - 4), ".EXE") == 0  && (WinGetKeyState(HWND_DESKTOP, VK_F12)&0x8000) )
             {
             _wpInsertPopupMenuItems(somSelf,
                                                  hwndMenu,
                                                  0,
                                                  hResource,
                                                  IDM_ZIPZAP_UNZIPEXE,
                                                  WPMENUID_PRIMARY);
             setConMenu(hwndMenu, IDM_ZIPZAP_UNZIPEXEFILE);
             }
          }
       }


    if( pgmData[22] )
       {
       _wpQueryRealName(somSelf, rPath, &rsize, TRUE);
       if( strlen(rPath) > 4 )
          {
          if( strcmpi(rPath + (strlen(rPath) - 4), ".ZIP") != 0 )
             {
             _wpInsertPopupMenuItems (somSelf,
                                                   hwndMenu,
                                                   iPosition,
                                                   hResource,
                                                   IDM_ZIPZAP_ZIPTHIS,
                                                   WPMENUID_PRIMARY);
             setConMenu(hwndMenu, ID_ZIPTHIS);
             }
          }
       else
          {
          _wpInsertPopupMenuItems (somSelf,
                                                hwndMenu,
                                                iPosition,
                                                hResource,
                                                IDM_ZIPZAP_ZIPTHIS,
                                                WPMENUID_PRIMARY);
          setConMenu(hwndMenu, ID_ZIPTHIS);
          }
       }

    if( pgmData[23] )
       {
       _wpQueryRealName(somSelf, rPath, &rsize, TRUE);
       _wpInsertPopupMenuItems (somSelf,
                                             hwndMenu,
                                             iPosition,
                                             hResource,
                                             IDM_ZIPZAP_ADDTOZIP,
                                             WPMENUID_PRIMARY);
       }
    
    
    return(TRUE);
}





SOM_Scope MRESULT  SOMLINK zipzapfileX_wpDragOver(zipzapfile *somSelf,
                                                  HWND hwndCnr,
                                                  PDRAGINFO pdrgInfo)
{
    CHAR dobj[ZZMAXPATH];
    ULONG dobjsize = sizeof(dobj);

    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpDragOver");

     
    setINI();

    if( pgmData[29] )
       {
       _wpQueryRealName(somSelf, dobj, &dobjsize, TRUE);
       if( pgmData[9] && strlen(dobj) > 4 && strcmpi(dobj + (strlen(dobj) - 4), ".ZIP") == 0 )
          return(MRFROM2SHORT(DOR_DROP, DO_UNKNOWN));
       else
          return (zipzapfile_parent_WPDataFile_wpDragOver(somSelf, hwndCnr,
                                                      pdrgInfo));
       }
    else  
       return (zipzapfile_parent_WPDataFile_wpDragOver(somSelf, hwndCnr,
                                                   pdrgInfo));
}





SOM_Scope HWND  SOMLINK zipzapfileX_wpViewObject(zipzapfile *somSelf,
                                                 HWND hwndCnr,
                                                 ULONG ulView,
                                                 ULONG param)
{
    CHAR voName[ZZMAXPATH];
    ULONG voNamesize = sizeof(voName);


    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpViewObject");
     
     
    setINI();

    if( pgmData[24] && pgmData[47] == 0 )
       {
       _wpQueryRealName(somSelf, voName, &voNamesize, TRUE);

       if( strlen(voName) > 4 && strcmpi(voName + (strlen(voName) - 4), ".ZIP") == 0 )
          {
          _beginthread(viewZipOnDClick, NULL, ZZSTACKSIZE, (PVOID)somSelf);
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          return(NULLHANDLE);
          }
       else
          return (zipzapfile_parent_WPDataFile_wpViewObject(somSelf,
                                                                                    hwndCnr,
                                                                                    ulView,
                                                                                    param));
       }
    else  
       return (zipzapfile_parent_WPDataFile_wpViewObject(somSelf,
                                                                                 hwndCnr,
                                                                                 ulView,
                                                                                 param));
}




SOM_Scope MRESULT  SOMLINK zipzapfileX_wpDrop(zipzapfile *somSelf,
                                              HWND hwndCnr, PDRAGINFO pdrgInfo,
                                              PDRAGITEM pdrgItem)
{
    CHAR selfName[ZZMAXPATH];
    ULONG selfNamesize = sizeof(selfName);
    CHAR szCont[ZZMAXPATH];
    CHAR szSource[ZZMAXPATH];
    CHAR obc[] = "drpObjectClass";
    HAB  habAnchor;


    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpDrop");

     
    setINI();

    if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
       strcpy(noeas, " -X ");
    else
       strcpy(noeas, "");

    if( pgmData[29] )
       {
       _wpQueryRealName(somSelf, selfName, &selfNamesize, TRUE);
       if( pgmData[9] && (strlen(selfName) > 4) )
          {
          if( strlen(selfName) > 4 && strcmpi(selfName + (strlen(selfName) - 4), ".ZIP") == 0 )
             {
             _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
             _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                           DTOP, &dtopsize, TRUE);
             if( pdrgInfo->cditem == 1 )
                {
                DrgQueryStrName(pdrgItem->hstrContainerName,
                             sizeof(szCont), szCont);
                DrgQueryStrName(pdrgItem->hstrSourceName,
                             sizeof(szSource), szSource);
                strcat(szCont, szSource);
                if( stricmp(selfName, szCont) == 0 )
                   {
                   return(zipzapfile_parent_WPDataFile_wpDrop(somSelf, hwndCnr,
                                                                               pdrgInfo, pdrgItem));
                   }
                if( _wpclsQueryFolder(_somGetClass(somSelf), szCont, FALSE) != NULL )
                   {
                   if( _wpQueryFileSize(somSelf) == 0 )
                      addDroppedFILES(" -r ", selfName, szCont, TRUE);
                   else
                      addDroppedFILES(" -r ", selfName, szCont, FALSE);
                   }
                else
                   {
                   if( _wpQueryFileSize(somSelf) == 0 )
                      addDroppedFILES(" -j ", selfName, szCont, TRUE);
                   else
                      addDroppedFILES(" -j ", selfName, szCont, FALSE);
                   }
                }
             else
                {
                PDRAGITEM di;
                INT k;

                di = DrgQueryDragitemPtr(pdrgInfo, 0);
                if( di == pdrgItem )
                   {
                   BOOL ISFOLD;
                   PROGDETAILS  pDetails;
                   ULONG dSize;
                   CHAR origPath[ZZMAXPATH];
                   CHAR dTopPath[ZZMAXPATH];
                   ULONG flgs;
                   CHAR pgmInputs[2000];
                   CHAR origdrv[3] = " :";
                   CHAR drv[3] = " :";
                   HFILE fhan;
                   APIRET rc;
                   ULONG act;
                   CHAR newline[] = "\n";
                   CHAR eoff[] = "@ECHO OFF";
                   CHAR cdtop[] = "cd\\";
                   CHAR cdup[] = "cd ..";
                   CHAR cdto[] = "cd";
                   CHAR noEA[] = "-X ";
                   CHAR space1[] = " ";
                   CHAR space2[] = "  ";
                   CHAR zipr[] = "zip -r";
                   CHAR zipj[] = "zip -j";
                   CHAR ziptrunc[] = "zip -qF";
                   CHAR zipadd[] = "zip";
                   CHAR zipdelete[] = "zip -q -d";
                   ULONG bwrote;
                   CHAR tmpDir[] = " :\\OS2";
                   CHAR fqtmpFile[] = " :\\OS2\\NFNFTMP.DOC";
                   CHAR tmpFile[] = "NFNFTMP.DOC";
                   CHAR tmpCMD[40];
                   CHAR tmpCMDName[40];
                   CHAR allFiles[] = "\\*";
                   CHAR quote[] = "\"";
                   CHAR foldName[ZZMAXPATH];
                   INT kz, iz;
                   CHAR tpath[ZZMAXPATH];
                   CHAR droppedFiles[ZZMAXPATH];
                   CHAR droppedFilesZ[ZZMAXPATH];
                   CHAR cmdParms[5];

                   setfnum = setCMDFileName(tmpCMD, tmpCMDName);

                   strcpy(dTopPath, DTOP);
                   strcat(dTopPath, "\\");

                   strcpy(pgmInputs, "/C cls");
                   strcat(pgmInputs, "&");
                   strcat(pgmInputs, tmpCMDName);

                   tmpDir[0] = DTOP[0];
                   fqtmpFile[0] = DTOP[0];
                   origdrv[0] = DTOP[0];
                   _getcwd(origPath, sizeof(origPath));

                   DosOpen(fqtmpFile, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
                   DosWrite(fhan, eoff, strlen(eoff), &bwrote);
                   DosClose(fhan);

                   DosOpen(tmpCMD, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
                   DosWrite(fhan, eoff, strlen(eoff), &bwrote);
                   DosWrite(fhan, newline, strlen(newline), &bwrote);
                   if( _wpQueryFileSize(somSelf) == 0 )
                      {
                      DosWrite(fhan, origdrv, strlen(drv), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);
                      DosWrite(fhan, cdto, strlen(cdto), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);
                      DosWrite(fhan, tmpDir, strlen(tmpDir), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);
                      DosWrite(fhan, ziptrunc, strlen(ziptrunc), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);
                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, selfName, strlen(selfName), &bwrote);
                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);
                      DosWrite(fhan, tmpFile, strlen(tmpFile), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);

                      DosWrite(fhan, zipdelete, strlen(zipdelete), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);
                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, selfName, strlen(selfName), &bwrote);
                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);

                      DosWrite(fhan, tmpFile, strlen(tmpFile), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);
                      DosWrite(fhan, cdtop, strlen(cdtop), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);
                      }
                   for( k=0;k<pdrgInfo->cditem;k++ )
                      {
                      di = DrgQueryDragitemPtr(pdrgInfo, k);
                      DrgQueryStrName(di->hstrContainerName,
                                   sizeof(droppedFiles), droppedFiles);
                      DrgQueryStrName(di->hstrSourceName,
                                   sizeof(szSource), szSource);
                      strcat(droppedFiles, szSource);
                      drv[0] = droppedFiles[0];
                      if( _wpclsQueryFolder(_somGetClass(somSelf), droppedFiles, FALSE) != NULL )
                         {
                         ISFOLD = TRUE;
                         strcpy(cmdParms, " -r ");
                         }
                      else
                         {
                         ISFOLD = FALSE;
                         strcpy(cmdParms, " -j ");
                         }

                      DosWrite(fhan, drv, strlen(drv), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);
                      DosWrite(fhan, cdto, strlen(cdto), &bwrote);
                      DosWrite(fhan, space1, strlen(space1), &bwrote);

                      strcpy(droppedFilesZ, droppedFiles);

                      if( droppedFilesZ[strlen(droppedFilesZ)-1] != '\\' )
                         {
                         if( strcmp(cmdParms, " -r ") == 0 )
                            strcat(droppedFilesZ, "\\");
                         }
                      else
                         {
                         if( strcmp(cmdParms, " -j ") == 0 )
                            droppedFilesZ[strlen(droppedFilesZ)-1] = '\0';
                         }

                      for( iz=0,kz=0;iz<strlen(droppedFilesZ);iz++ )
                         {
                         if( droppedFilesZ[iz] == '\\' )
                            kz = iz;
                         }

                      if( kz == 2 )
                         {
                         strncpy(tpath, droppedFilesZ, kz+1);
                         tpath[kz+1] = '\0';
                         }
                      else
                         {
                         strncpy(tpath, droppedFilesZ, kz);
                         tpath[kz] = '\0';
                         }

                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, tpath, strlen(tpath), &bwrote);
                      DosWrite(fhan, quote, strlen(quote), &bwrote);
                      DosWrite(fhan, newline, strlen(newline), &bwrote);

                      if( strcmp(cmdParms, " -r ") == 0 )
                         {
                         DosWrite(fhan, cdup, strlen(cdup), &bwrote);
                         DosWrite(fhan, newline, strlen(newline), &bwrote);
                         }

                      for( iz=0,kz=0;iz<strlen(droppedFiles);iz++ )
                         {
                         if( droppedFiles[iz] == '\\' )
                            kz = iz;
                         }

                      strncpy(foldName, droppedFiles+(kz+1), strlen(droppedFiles)-(kz+1));
                      foldName[strlen(droppedFiles)-(kz+1)] = '\0';

                      if( strcmp(cmdParms, " -j ") == 0 )
                         {
                         DosWrite(fhan, zipj, strlen(zipr), &bwrote);
                         DosWrite(fhan, space1, strlen(space1), &bwrote);
                         if( strlen(noeas) > 0 )
                            DosWrite(fhan, noEA, strlen(noEA), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, selfName, strlen(selfName), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, space1, strlen(space1), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, foldName, strlen(foldName), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, newline, strlen(newline), &bwrote);
                         }
                      else
                         {
                         DosWrite(fhan, zipr, strlen(zipr), &bwrote);
                         DosWrite(fhan, space1, strlen(space1), &bwrote);
                         if( strlen(noeas) > 0 )
                            DosWrite(fhan, noEA, strlen(noEA), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, selfName, strlen(selfName), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, space1, strlen(space1), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, foldName, strlen(foldName), &bwrote);
                         DosWrite(fhan, allFiles, strlen(allFiles), &bwrote);
                         DosWrite(fhan, quote, strlen(quote), &bwrote);
                         DosWrite(fhan, newline, strlen(newline), &bwrote);
                         }
                      }
                   DosWrite(fhan, cdtop, strlen(cdtop), &bwrote);
                   DosWrite(fhan, newline, strlen(newline), &bwrote);
                   DosWrite(fhan, origdrv, strlen(origdrv), &bwrote);
                   DosWrite(fhan, newline, strlen(newline), &bwrote);

                   DosWrite(fhan, cdto, strlen(cdto), &bwrote);
                   DosWrite(fhan, space1, strlen(space1), &bwrote);
                   DosWrite(fhan, quote, strlen(quote), &bwrote);
                   DosWrite(fhan, origPath, strlen(origPath), &bwrote);
                   DosWrite(fhan, quote, strlen(quote), &bwrote);

                   DosClose(fhan);

                   WinRegisterClass (habAnchor, obc, drpProc, 0, 0);

                   hwndDRP = WinCreateWindow(HWND_OBJECT,
                                                              obc,
                                                              NULL,
                                                              0,
                                                              0,
                                                              0,
                                                              0,
                                                              0,
                                                              HWND_OBJECT,
                                                              HWND_BOTTOM,
                                                              0L,
                                                              (PVOID)NULL,
                                                              (PVOID)NULL);

                   if( pgmData[10] && !pgmData[11] )
                      flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
                   if( !pgmData[10] && pgmData[11] )
                      flgs = SWP_HIDE;
                   if( pgmData[10] && pgmData[11] )
                      flgs = SWP_ACTIVATE | SWP_SHOW;
                   if( !pgmData[10] && !pgmData[11] )
                      flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

                   pDetails.Length          = sizeof(PROGDETAILS);
                   pDetails.progt.progc     = PROG_DEFAULT;
                   pDetails.progt.fbVisible = SHE_VISIBLE;
                   pDetails.pszTitle        = "ZipZap ADD TO ZIP!";
                   pDetails.pszExecutable   = "cmd.exe";
                   pDetails.pszParameters   = pgmInputs;
                   pDetails.pszStartupDir   = "";
                   pDetails.pszIcon         = "";
                   pDetails.pszEnvironment  = "";
                   pDetails.swpInitial.fl   = flgs;
                   pDetails.swpInitial.cy   = 0;
                   pDetails.swpInitial.cx   = 0;
                   pDetails.swpInitial.y    = 0;
                   pDetails.swpInitial.x    = 0;
                   pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
                   pDetails.swpInitial.hwnd             = hwndDRP;
                   pDetails.swpInitial.ulReserved1      = 0;
                   pDetails.swpInitial.ulReserved2      = 0;

                  WinStartApp(hwndDRP, &pDetails, pgmInputs, NULL, 1);

                   DrgDeleteDraginfoStrHandles(pdrgInfo) ;
                   DrgFreeDraginfo(pdrgInfo);
                   }
                }
             }
          }
       }
    
    return (zipzapfile_parent_WPDataFile_wpDrop(somSelf, hwndCnr,
                                                pdrgInfo, pdrgItem));
}





SOM_Scope BOOL  SOMLINK zipzapfileX_wpMenuItemSelected(zipzapfile *somSelf,
                                                       HWND hwndFrame,
                                                       ULONG ulMenuId)
{
    BOOL result;


    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpMenuItemSelected");

    result = TRUE;
    
      
    switch( ulMenuId )
       {
       case ID_VIEWZIP :
          if( _wpQueryFileSize(somSelf) < MINZIPSIZE )
             {
             _beginthread(noFiles, NULL, ZZSTACKSIZE, (PVOID)somSelf);
             break;
             }
          _beginthread(viewZipOnDClick, NULL, ZZSTACKSIZE, (PVOID)somSelf);
          break;

       case ID_CZIPTHIS :
       case ID_ZIPTHIS :
       case ID_SZIPTHIS :
          {
          SOMAny *ob;
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR pgmInputs[ZZMAXPATH];
          CHAR fqselfName[ZZMAXPATH];
          CHAR selfNameBase[ZZMAXPATH];
          CHAR selfName[ZZMAXPATH];
          ULONG fqssize = sizeof(fqselfName);
          ULONG ssize = sizeof(selfName);
          CHAR tmpPath[] = " :\\OS2";
          CHAR tmpFile[] = "show_me.doc";
          INT i, k, nlen;
          HOBJECT destobj;
          CHAR destPath[ZZMAXPATH];
          CHAR foldName[ZZMAXPATH];
          PSZ tstr;
          CHAR obc[] = "ztObjectClass";
          HAB  habAnchor;
          BOOL DOUPPER;
          INT fln;



          if( _wpQueryFileSize(somSelf) == 0 )
             {
             _beginthread(noBytes, NULL, ZZSTACKSIZE, (PVOID)somSelf);
             break;
             }

          USECUSTOMZT = FALSE;
          if( ulMenuId == ID_CZIPTHIS )
             {
             if( WinDlgBox(HWND_DESKTOP,
                                HWND_DESKTOP,
                                cztProc,
                                hResource,
                                ID_CZTDLG, (PVOID)1) )
                {
                USECUSTOMZT = TRUE;
                }
             else
                break;
             }

          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          if( !ZTINPROGRESS )
             {
             ZTINPROGRESS = TRUE;
             }
          else
             break;

         _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                     DTOP, &dtopsize, TRUE);

          setINI();

          if( !chkValidDPStr(DFSTR) )
             {
             DosBeep(1200, 50);
             strcpy(DFSTR, DFAULTDESTZ);
             queryZZSet();
             saveZZSet();
             }

          tmpPath[0] = DTOP[0];
          _wpQueryRealName(somSelf, fqselfName, &fqssize, TRUE);
          tstr = _wpQueryTitle(somSelf);
          sprintf(selfName, "%s", tstr);
          strcpy(selfNameBase, selfName);

          for( i=0,k=0;i<strlen(fqselfName);i++ )
             {
             if( fqselfName[i] == '\\' )
                k = i;
             }

          strncpy(foldName, fqselfName, k);
          foldName[k] = '\0';

          strcpy(pgmInputs, "/C zip ");
          if( strlen(noeas) > 0 )
             strcat(pgmInputs, noeas);
          if( strlen(zipArgs) > 0 )
             {
             if( USECUSTOMZT )
                {
                strcat(pgmInputs, czipArgs);
                strcat(pgmInputs, " ");
                }
             else
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " ");
                }
             }
          strcat(pgmInputs, "\"");
          if( USECUSTOMZT )
             {
             strcat(pgmInputs, CDFSTR);
             if( CDFSTR[strlen(CDFSTR)-1] != '\\' )
                strcat(pgmInputs, "\\");
             }
          else
             {
             strcat(pgmInputs, DFSTR);
             if( DFSTR[strlen(DFSTR)-1] != '\\' )
                strcat(pgmInputs, "\\");
             }

          nlen = strlen(selfNameBase);

          if( nlen == 3 && selfNameBase[nlen-2] == '.' )
             selfNameBase[nlen-2] = '\0';

          if( nlen == 4 )
             {
             if( selfNameBase[nlen-2] == '.' )
                selfNameBase[nlen-2] = '\0';
             if( selfNameBase[nlen-3] == '.' )
                selfNameBase[nlen-3] = '\0';
             }

          if( nlen > 4 )
             {
             if( selfNameBase[nlen-2] == '.' )
                selfNameBase[nlen-2] = '\0';
             if( selfNameBase[nlen-3] == '.' )
                selfNameBase[nlen-3] = '\0';
             if( selfNameBase[nlen-4] == '.' )
                selfNameBase[nlen-4] = '\0';
             }

          DOUPPER = FALSE;
          for( fln=0;fln<strlen(selfNameBase);fln++ )
             {
             if( (UINT)selfNameBase[fln] > 64 && (UINT)selfNameBase[fln] < 91 )
                DOUPPER = TRUE;
             }

          strcat(pgmInputs, selfNameBase);
          if( DOUPPER )
             strcat(pgmInputs, ".ZIP");
          else
             strcat(pgmInputs, ".zip");
          strcat(pgmInputs, "\"");
          strcat(pgmInputs, " ");
          strcat(pgmInputs, "\"");
          strcat(pgmInputs, selfName);
          strcat(pgmInputs, "\"");

          if( USECUSTOMZT )
             strcpy(destPath, CDFSTR);
          else
             strcpy(destPath, DFSTR);

          if( stricmp(destPath, DTOP) == 0 )
             {
             }
          else
             {
             INT f;

             makeFolders(destPath);
             if( destPath[strlen(destPath) - 1] == '\\' )
                {
                CHAR tmpS[ZZMAXPATH];

                strcpy(tmpS, destPath);
                tmpS[strlen(destPath)-1] = '\0';
                destobj = WinQueryObject(tmpS);
                }
             else
                {
                destobj = WinQueryObject(destPath);
                strcat(destPath, "\\");
                }
             if( pgmData[46] )
                makeShadow(destPath, "<WP_DESKTOP>");
             }

          WinRegisterClass (habAnchor, obc, ztProc, 0, 0);

          hwndZT = WinCreateWindow(HWND_OBJECT,
                                                   obc,
                                                   NULL,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   0,
                                                   HWND_OBJECT,
                                                   HWND_BOTTOM,
                                                   0L,
                                                   (PVOID)NULL,
                                                   (PVOID)NULL);

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap ZIPS!";
          pDetails.pszExecutable   = "cmd.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = foldName;
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = hwndZT;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          if( WinStartApp(hwndZT, &pDetails, pgmInputs, NULL, 1) == 0 )
             {
             ZTINPROGRESS = FALSE;
             WinDestroyWindow(hwndZT) ;
             }
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;


       case ID_ADDTOZIP :
          {
          CHAR FN[ZZMAXPATH];
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR pgmInputs[ZZMAXPATH];
          CHAR fqselfName[ZZMAXPATH];
          ULONG fqssize = sizeof(fqselfName);
          CHAR selfName[ZZMAXPATH];
          ULONG ssize = sizeof(selfName);
          CHAR foldName[ZZMAXPATH];
          INT i, k;
          BOOL rc;
          PSZ tstr;
          SOMAny *tobj;
          CHAR tmpFile[] = " :\\OS2\\ZZ$Z$.TMP";
          HFILE fhan;
          ULONG bwrote;
          ULONG act;
          CHAR junk[] = " ";



          if( _wpQueryFileSize(somSelf) == 0 )
             {
             _beginthread(noBytes, NULL, ZZSTACKSIZE, (PVOID)somSelf);
             break;
             }

          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          setINI();

          rc = FindFile(HWND_DESKTOP, FN);
          if( !rc || strlen(FN) == 0 )
             break;

          tstr = _wpQueryTitle(somSelf);
          sprintf(selfName, "%s", tstr);
          _wpQueryRealName(somSelf, fqselfName, &fqssize, TRUE);

          for( i=0,k=0;i<strlen(fqselfName);i++ )
             {
             if( fqselfName[i] == '\\' )
                k = i;
             }

          strncpy(foldName, fqselfName, k);
          foldName[k] = '\0';

          tobj = _wpclsQueryObjectFromPath(_WPFileSystem, FN);
          if( _wpQueryFileSize(tobj) == 0 )
             {
             _wpUnlockObject(tobj);
             _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                       DTOP, &dtopsize, TRUE);
             tmpFile[0] = DTOP[0];
             DosOpen(tmpFile, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
             DosWrite(fhan, junk, strlen(junk), &bwrote);
             DosClose(fhan);

             strcpy(pgmInputs, "/C zip -qF ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "zip -q -d ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "*");
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "erase ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");


             strcat(pgmInputs, "zip ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " ");
                }
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\"");
             }
          else
             {
             _wpUnlockObject(tobj);

             strcpy(pgmInputs, "/C zip ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " ");
                }
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\"");
             }

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap ADD TO ZIP!";
          pDetails.pszExecutable   = "cmd.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = foldName;
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = NULLHANDLE;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, SAF_INSTALLEDCMDLINE);
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case IDM_ZIPZAP_UNZIPME:
       case IDM_ZIPZAP_SUNZIPME:
       case IDM_ZIPZAP_CUNZIPME:
          {
          CHAR stPath[ZZMAXPATH];
          ULONG rsize = sizeof(stPath);
          HOBJECT hobj, hobjP;
          INT i,k;
          CHAR tStr[ZZMAXPATH];
          BOOL WORKING, FOUND;
          CHAR dTopPath[ZZMAXPATH];
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR flName[ZZMAXPATH];
          ULONG flsize = sizeof(flName);
          CHAR foldName[ZZMAXPATH];
          CHAR destPath[ZZMAXPATH];
          CHAR pgmInputs[ZZMAXPATH];
          PSZ tstr;
          CHAR obc[] = "uzmObjectClass";
          HAB  habAnchor;



          if( _wpQueryFileSize(somSelf) < MINZIPSIZE )
             {
             _beginthread(noFiles, NULL, ZZSTACKSIZE, (PVOID)somSelf);
             break;
             }

          USECUSTOMUZT = FALSE;
          if( ulMenuId == IDM_ZIPZAP_CUNZIPME )
             {
             if( WinDlgBox(HWND_DESKTOP,
                                HWND_DESKTOP,
                                cuztProc,
                                hResource,
                                ID_CUZTDLG, 0) )
                {
                USECUSTOMUZT = TRUE;
                }
             else
                break;
             }

          if( !UZMINPROGRESS )
             {
             UZMINPROGRESS = TRUE;
             }
          else
             break;

          setINI();
          strcpy(dTopPath, DTOP);
          strcat(dTopPath, "\\");


          if( !chkValidDPStr(ZDSTR) )
             {
             DosBeep(1200, 50);
             strcpy(ZDSTR, DTOP);
             saveZZSet();
             queryZZSet();
             }

          _wpQueryRealName(somSelf, stPath, &rsize, TRUE);
          tstr = _wpQueryTitle(somSelf);
          sprintf(flName, "%s", tstr);

          //************make folder name *******

          strcpy(foldName, flName);
          foldName[strlen(flName)-4] = '\0';


          //****** destination path *****
          if( USECUSTOMUZT )
             strcpy(destPath, CZDSTR);
          else
             strcpy(destPath, ZDSTR);

          if( stricmp(destPath, DTOP) == 0 )
             {
             if( destPath[strlen(destPath) - 1] != '\\' )
                strcat(destPath, "\\");
             strcat(destPath, foldName);
             hobj = WinCreateObject("WPFolder",
                                    foldName,
                                    "CLOSED=DEFAULT",
                                    "<WP_DESKTOP>",
                                    CO_FAILIFEXISTS);
             }
          else
             {
             INT f;

             makeFolders(destPath);
             if( destPath[strlen(destPath) - 1] == '\\' )
                {
                CHAR tmpS[ZZMAXPATH];

                strcpy(tmpS, destPath);
                tmpS[strlen(destPath)-1] = '\0';
                hobjP = WinQueryObject(tmpS);
                }
             else
                {
                hobjP = WinQueryObject(destPath);
                strcat(destPath, "\\");
                }
             strcpy(ZDSTRP, destPath);
             if( ZDSTRP[strlen(ZDSTRP)-1] != '\\' )
                strcat(ZDSTRP, "\\");
             strcat(ZDSTRP, foldName);
             if( pgmData[8] )
                {
                makeShadow(destPath, "<WP_DESKTOP>");
                }
             strcat(destPath, foldName);
             makeFolders(destPath);
             hobj = WinQueryObject(destPath);
             if( pgmData[6] )
                {
                makeShadow(destPath, "<WP_DESKTOP>");
                }
             }

          if( USECUSTOMUZT )
             {
             if( strlen(CUNZIPARGS) > 0 )
                {
                strcpy(pgmInputs, CUNZIPARGS);
                strcat(pgmInputs, " ");
                strcat(pgmInputs, "\"");
                }
             else
                strcpy(pgmInputs, "\"");
             }
          else
             {
             if( strlen(UNZIPARGS) > 0 )
                {
                strcpy(pgmInputs, UNZIPARGS);
                strcat(pgmInputs, " ");
                strcat(pgmInputs, "\"");
                }
             else
                strcpy(pgmInputs, "\"");
             }
          strcat(pgmInputs, stPath);
          strcat(pgmInputs, "\"");
          strcat(pgmInputs, " -d ");
          strcat(pgmInputs, "\"");
          strcat(pgmInputs, destPath);
          strcat(pgmInputs, "\"");

          WinRegisterClass (habAnchor, obc, uzmProc, 0, 0);

          hwndUZM = WinCreateWindow(HWND_OBJECT,
                                                     obc,
                                                     NULL,
                                                     0,
                                                     0,
                                                     0,
                                                     0,
                                                     0,
                                                     HWND_OBJECT,
                                                     HWND_BOTTOM,
                                                     0L,
                                                     (PVOID)NULL,
                                                     (PVOID)NULL);

          if( pgmData[3] && !pgmData[4] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[3] && pgmData[4] )
             flgs = SWP_HIDE;
          if( pgmData[3] && pgmData[4] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[3] && !pgmData[4] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap UNZIPS!";
          pDetails.pszExecutable   = "unzip.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = "";
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = hwndUZM;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          if( WinStartApp(hwndUZM, &pDetails, pgmInputs, NULL, 1) == 0 )
             {
             UZMINPROGRESS = FALSE;
             WinDestroyWindow(hwndUZM) ;
             }
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case IDM_ZIPZAP_UNZIPEXEFILE:
       case IDM_ZIPZAP_SUNZIPEXEFILE:
       case IDM_ZIPZAP_CUNZIPEXEFILE:
          {
          CHAR stPath[ZZMAXPATH];
          ULONG rsize = sizeof(stPath);
          HOBJECT hobj, hobjP;
          INT i,k;
          CHAR tStr[ZZMAXPATH];
          BOOL WORKING, FOUND;
          CHAR dTopPath[ZZMAXPATH];
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR flName[ZZMAXPATH];
          ULONG flsize = sizeof(flName);
          CHAR foldName[ZZMAXPATH];
          CHAR destPath[ZZMAXPATH];
          CHAR pgmInputs[ZZMAXPATH];
          PSZ tstr;
          CHAR obc[] = "uzmObjectClass";
          HAB  habAnchor;
          SOMAny  *pfold;
          CHAR sobn[ZZMAXPATH];
          ULONG sobnsize = sizeof(sobn);



          USECUSTOMUZT = FALSE;
          if( ulMenuId == IDM_ZIPZAP_CUNZIPEXEFILE )
             {
             if( WinDlgBox(HWND_DESKTOP,
                                HWND_DESKTOP,
                                cuzexeProc,
                                hResource,
                                ID_CUZEXEDLG, 0) )
                {
                USECUSTOMUZT = TRUE;
                }
             else
                break;
             }

          if( !UZEXEINPROGRESS )
             {
             UZEXEINPROGRESS = TRUE;
             }
          else
             break;

          strcpy(EXEZIP, "");
          setINI();
          strcpy(dTopPath, DTOP);
          strcat(dTopPath, "\\");

          if( !chkValidDPStr(ZDSTR) )
             {
             DosBeep(1200, 50);
             strcpy(ZDSTR, DTOP);
             saveZZSet();
             queryZZSet();
             }

          _wpQueryRealName(somSelf, stPath, &rsize, TRUE);
          _wpQueryRealName(somSelf, sobn, &sobnsize, FALSE);


          //****** destination path *****
          if( USECUSTOMUZT )
             strcpy(destPath, CZDSTR);
          else
             strcpy(destPath, ZDSTR);

          if( stricmp(destPath, DTOP) == 0 )
             {
             }
          else
             {
             INT f;


             makeFolders(destPath);
             if( destPath[strlen(destPath) - 1] == '\\' )
                {
                CHAR tmpS[ZZMAXPATH];

                strcpy(tmpS, destPath);
                tmpS[strlen(destPath)-1] = '\0';
                hobjP = WinQueryObject(tmpS);
                }
             else
                {
                hobjP = WinQueryObject(destPath);
                strcat(destPath, "\\");
                }
             strcpy(ZDSTRP, destPath);
             strcpy(EXEZIP, sobn);
             if( pgmData[8] )
                {
                makeShadow(destPath, "<WP_DESKTOP>");
                }
             }

          if( strlen(destPath) > 4 && destPath[strlen(destPath)-1] == '\\' )
               destPath[strlen(destPath)-1] = '\0';

          pfold = _wpclsQueryObjectFromPath(_WPFileSystem, destPath);
          _wpCopyObject(somSelf, pfold, FALSE);
          _wpUnlockObject(pfold);

          strcpy(pgmInputs, "/C ");
          strcat(pgmInputs, sobn);

          WinRegisterClass (habAnchor, obc, uzexeProc, 0, 0);

          hwndUZEXE = WinCreateWindow(HWND_OBJECT,
                                                     obc,
                                                     NULL,
                                                     0,
                                                     0,
                                                     0,
                                                     0,
                                                     0,
                                                     HWND_OBJECT,
                                                     HWND_BOTTOM,
                                                     0L,
                                                     (PVOID)NULL,
                                                     (PVOID)NULL);

          if( pgmData[3] && !pgmData[4] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[3] && pgmData[4] )
             flgs = SWP_HIDE;
          if( pgmData[3] && pgmData[4] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[3] && !pgmData[4] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap UNZIPS!";
          pDetails.pszExecutable   = "cmd.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = destPath;
          pDetails.pszIcon         = NULL;
          pDetails.pszEnvironment  = "WORKPLACE\0\0";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = hwndUZEXE;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          if( WinStartApp(hwndUZEXE, &pDetails, pgmInputs, NULL, 1) == 0 )
             {
             UZEXEINPROGRESS = FALSE;
             WinDestroyWindow(hwndUZEXE) ;
             DosBeep(3700, 100);
             }
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       default:
          result =  zipzapfile_parent_WPDataFile_wpMenuItemSelected(somSelf,
                                                                                          hwndFrame,
                                                                                          ulMenuId);
          break;
       }
    // result =  zipzapfile_parent_WPDataFile_wpMenuItemSelected(somSelf,
    //                                                                                      hwndFrame,
                                                                                          ulMenuId);
    return (result);
}





SOM_Scope BOOL  SOMLINK zipzapfileX_wpSetIcon(zipzapfile *somSelf,
                                              HPOINTER hptrNewIcon)
{
    CHAR selfName[ZZMAXPATH];
    ULONG selfNamesize = sizeof(selfName);


    zipzapfileData *somThis = zipzapfileGetData(somSelf);
    zipzapfileMethodDebug("zipzapfile","zipzapfileX_wpSetIcon");

    
    if( _somIsA(somSelf, _WPDataFile) )
       {
       _wpQueryRealName(somSelf, selfName, &selfNamesize, TRUE);

       if( strlen(selfName) > 4 )
          {
          strupr(selfName);
          if( strcmpi(selfName + (strlen(selfName) - 4), ".ZIP") == 0 && pgmData[0] )
             {
             // hptr = WinLoadFileIcon(ZIPICON, FALSE);
             if(hptr)
                return(zipzapfile_parent_WPDataFile_wpSetIcon(somSelf, hptr));
             else
                return (zipzapfile_parent_WPDataFile_wpSetIcon(somSelf, hptrNewIcon));
             }
          else
             return (zipzapfile_parent_WPDataFile_wpSetIcon(somSelf, hptrNewIcon));
          }
       else
          return (zipzapfile_parent_WPDataFile_wpSetIcon(somSelf, hptrNewIcon));
       }
    else 
       return (zipzapfile_parent_WPDataFile_wpSetIcon(somSelf, hptrNewIcon));
}





SOM_Scope void  SOMLINK zipzapfileX_wpclsInitData(M_zipzapfile *somSelf)
{
    M_zipzapfileData *somThis = M_zipzapfileGetData(somSelf);
    M_zipzapfileMethodDebug("M_zipzapfile","zipzapfileX_wpclsInitData");


    ZTINPROGRESS = FALSE;
    UZMINPROGRESS = FALSE;
    ZFOLINPROGRESS = FALSE;
    UZEXEINPROGRESS = FALSE;
    DRPINPROGRESS = FALSE;
    // hptr = WinLoadFileIcon(ZIPICON, FALSE);

    M_zipzapfile_parent_M_WPDataFile_wpclsInitData(somSelf);
}






SOM_Scope void  SOMLINK zipzapfileX_wpclsUnInitData(M_zipzapfile *somSelf)
{
    M_zipzapfileData *somThis = M_zipzapfileGetData(somSelf);
    M_zipzapfileMethodDebug("M_zipzapfile","zipzapfileX_wpclsUnInitData");

    M_zipzapfile_parent_M_WPDataFile_wpclsUnInitData(somSelf);
}
*/






//****************************************************************
//****************************************************************
//****************************************************************
//************************   FOLDERS ******************************
//****************************************************************
//****************************************************************







SOM_Scope BOOL  SOMLINK zipzapfolderX_wpModifyPopupMenu(zipzapfolder *somSelf,
                                                        HWND hwndMenu,
                                                        HWND hwndCnr,
                                                        ULONG iPosition)
{
    BOOL HASFOLD, HASFILES, ISDESKTOP;
    CHAR dTopFoldX[ZZMAXPATH];
    ULONG rsize = sizeof(dTopFoldX);
    CHAR fpath[ZZMAXPATH];
    FILEFINDBUF3 findbuf;
    HDIR hDir = HDIR_CREATE;
    ULONG usSearchCount = 1;
    ULONG ulStyle;


    zipzapfolderData *somThis = zipzapfolderGetData(somSelf);
    zipzapfolderMethodDebug("zipzapfolder","zipzapfolderX_wpModifyPopupMenu");

    zipzapfolder_parent_WPFolder_wpModifyPopupMenu(somSelf,
                                                                        hwndMenu,
                                                                        hwndCnr,
                                                                        iPosition);
    
    /*
    if( _wpQueryRealName(somSelf, dTopFoldX, &rsize, TRUE) )
       {
       strcpy(fpath, dTopFoldX);
       strcat(fpath, "\\*");

       _wpContainsFolders(somSelf, &HASFOLD);
       
       if( _somIsA(somSelf, _WPDesktop) )
          ISDESKTOP = TRUE;
       else
          ISDESKTOP = FALSE;

       if( DosFindFirst(fpath, &hDir,
                        FILE_NORMAL | FILE_ARCHIVED | FILE_SYSTEM | FILE_READONLY | FILE_HIDDEN,
                        (PVOID)&findbuf, sizeof(findbuf), &usSearchCount, FIL_STANDARD) )
          HASFILES = FALSE;
       else
          HASFILES = TRUE;
       DosFindClose(hDir);


       if( ISDESKTOP || (WinGetKeyState(HWND_DESKTOP, VK_F12)&0x8000) )
          {
          if( pgmData[56] == 0 || (WinGetKeyState(HWND_DESKTOP, VK_F12)&0x8000) )
             {
             _wpInsertPopupMenuItems(somSelf,
                                       hwndMenu,
                                       0,
                                       hResource,
                                       IDM_ZIPZAPFILE_MAIN,
                                       WPMENUID_PRIMARY);
             setConMenu(hwndMenu, IDMFILE_ZIPZAPSETTINGS);
             }
          }


       if( !ISDESKTOP )
          {
          if( pgmData[42] == 1 )
             {
             if( HASFILES )
                _wpInsertPopupMenuItems(somSelf,
                                       hwndMenu,
                                       0,
                                       hResource,
                                       IDM_ZIPZAP_ADDFOLDTOZIP,
                                       WPMENUID_PRIMARY);

             if( HASFOLD )
                _wpInsertPopupMenuItems(somSelf,
                                       hwndMenu,
                                       0,
                                       hResource,
                                       IDM_ZIPZAP_ADDTREETOZIP,
                                       WPMENUID_PRIMARY);
             }

          if( pgmData[41] == 1 )
             {
             if( HASFILES )
                _wpInsertPopupMenuItems(somSelf,
                                       hwndMenu,
                                       0,
                                       hResource,
                                       IDM_ZIPZAP_ZIPFOL,
                                       WPMENUID_PRIMARY);
             setConMenu(hwndMenu, ID_ZIPFOL);
             }

          if( pgmData[53] == 1 )
             {
             if( HASFOLD )
                _wpInsertPopupMenuItems(somSelf,
                                       hwndMenu,
                                       0,
                                       hResource,
                                       IDM_ZIPZAP_ZIPTRE,
                                       WPMENUID_PRIMARY);
             setConMenu(hwndMenu, ID_ZIPTRE);
             }
          }
       }
    */

    return(TRUE);
}




SOM_Scope BOOL  SOMLINK zipzapfolderX_wpMenuItemSelected(zipzapfolder *somSelf,
                                                         HWND hwndFrame,
                                                         ULONG ulMenuId)
{
    BOOL result;


    zipzapfolderData *somThis = zipzapfolderGetData(somSelf);
    zipzapfolderMethodDebug("zipzapfolder","zipzapfolderX_wpMenuItemSelected");

    /*
    result = TRUE;

    switch( ulMenuId )
       {
       case IDMFILE_SZIPZAPSETTINGS:
       case IDMFILE_ZIPZAPSETTINGS:
          {
          _beginthread(zzSettingsPage, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case IDM_ZIPZAP_CCREATENEW:
          {
          _beginthread(createNewDlg, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case IDM_ZIPZAP_CABOUTZIPZAP:
          {
          _beginthread(aboutDlg, NULL, ZZSTACKSIZE, (PVOID)3);
          }
          break;

       case ID_ADDFOLDTOZIP:
          {
          CHAR FN[ZZMAXPATH];
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR pgmInputs[ZZMAXPATH];
          CHAR selfName[ZZMAXPATH];
          ULONG ssize = sizeof(selfName);
          CHAR fqselfName[ZZMAXPATH];
          ULONG fqssize = sizeof(fqselfName);
          INT i, k;
          BOOL rc;
          PSZ tstr;
          SOMAny *tobj;
          CHAR tmpFile[] = " :\\OS2\\ZZ$Z$.TMP";
          HFILE fhan;
          ULONG bwrote;
          ULONG act;
          CHAR junk[] = " ";


          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                       DTOP, &dtopsize, TRUE);

          setINI();

          rc = FindFile(HWND_DESKTOP, FN);
          if( !rc || strlen(FN) == 0 )
             break;

          _wpQueryRealName(somSelf, fqselfName, &fqssize, TRUE);
          tstr = _wpQueryTitle(somSelf);
          sprintf(selfName, "%s", tstr);


          tobj = _wpclsQueryObjectFromPath(_WPFileSystem, FN);
          if( _wpQueryFileSize(tobj) == 0 )
             {
             _wpUnlockObject(tobj);
             _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                       DTOP, &dtopsize, TRUE);
             tmpFile[0] = DTOP[0];
             DosOpen(tmpFile, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
             DosWrite(fhan, junk, strlen(junk), &bwrote);
             DosClose(fhan);

             strcpy(pgmInputs, "/C zip -qF ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "zip -q -d ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "*");
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "erase ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");


             strcat(pgmInputs, "cd..");
             strcat(pgmInputs, "&zip ");
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " -S -D ");
                }
             else
                strcat(pgmInputs, "-S -D ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\\*");
             strcat(pgmInputs, "\"");
             }
          else
             {
             _wpUnlockObject(tobj);

             strcpy(pgmInputs, "/C cd..");
             strcat(pgmInputs, "&zip ");
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " -S -D ");
                }
             else
                strcat(pgmInputs, "-S -D ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\\*");
             strcat(pgmInputs, "\"");
             }

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "Add to ZIP";
          pDetails.pszExecutable   = "cmd.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = fqselfName;
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = NULLHANDLE;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, 1);
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case ID_ADDTREETOZIP:
          {
          CHAR FN[ZZMAXPATH];
          PROGDETAILS  pDetails;
          ULONG flgs;
          CHAR pgmInputs[ZZMAXPATH];
          CHAR selfName[ZZMAXPATH];
          ULONG ssize = sizeof(selfName);
          CHAR fqselfName[ZZMAXPATH];
          ULONG fqssize = sizeof(fqselfName);
          INT i, k;
          BOOL rc;
          PSZ tstr;
          SOMAny *tobj;
          CHAR tmpFile[] = " :\\OS2\\ZZ$Z$.TMP";
          HFILE fhan;
          ULONG bwrote;
          ULONG act;
          CHAR junk[] = " ";


          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                    DTOP, &dtopsize, TRUE);

          setINI();

          rc = FindFile(HWND_DESKTOP, FN);
          if( !rc || strlen(FN) == 0 )
             break;

          _wpQueryRealName(somSelf, fqselfName, &fqssize, TRUE);
          tstr = _wpQueryTitle(somSelf);
          sprintf(selfName, "%s", tstr);

          tobj = _wpclsQueryObjectFromPath(_WPFileSystem, FN);
          if( _wpQueryFileSize(tobj) == 0 )
             {
             _wpUnlockObject(tobj);
             _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                       DTOP, &dtopsize, TRUE);
             tmpFile[0] = DTOP[0];
             DosOpen(tmpFile, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
             DosWrite(fhan, junk, strlen(junk), &bwrote);
             DosClose(fhan);

             strcpy(pgmInputs, "/C zip -qF ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "zip -q -d ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "*");
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "erase ");
             strcat(pgmInputs, tmpFile);
             strcat(pgmInputs, "&");

             strcat(pgmInputs, "cd..");
             strcat(pgmInputs, "&zip ");
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " -r -S ");
                }
             else
                strcat(pgmInputs, "-r -S ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\\*");
             strcat(pgmInputs, "\"");
             }
          else
             {
             _wpUnlockObject(tobj);

             strcpy(pgmInputs, "/C cd..");
             strcat(pgmInputs, "&zip ");
             if( strlen(zipArgs) > 0 )
                {
                strcat(pgmInputs, zipArgs);
                strcat(pgmInputs, " -r -S ");
                }
             else
                strcat(pgmInputs, "-r -S ");
             if( strlen(noeas) > 0 )
                strcat(pgmInputs, noeas);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, FN);
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, " ");
             strcat(pgmInputs, "\"");
             strcat(pgmInputs, selfName);
             strcat(pgmInputs, "\\*");
             strcat(pgmInputs, "\"");
             }

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap ADD TO ZIP!";
          pDetails.pszExecutable   = "cmd.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = fqselfName;
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = NULLHANDLE;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, 1);
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          }
          break;

       case ID_ZIPFOL:
       case ID_SZIPFOL:
       case ID_CZIPFOL:
          {
          HOBJECT hobj;
          INT i, lastS;
          CHAR dTopFold[ZZMAXPATH];
          CHAR fqZipFile[ZZMAXPATH];
          ULONG rsize;
          PROGDETAILS  pDetails;
          CHAR dTop[ZZMAXPATH];
          ULONG flgs;
          CHAR foldName[ZZMAXPATH];
          CHAR pgmInputs[ZZMAXPATH];
          SOMAny *fol;
          CHAR destPath[ZZMAXPATH];
          PSZ tstr;
          CHAR obc[] = "zfolObjectClass";
          HAB  habAnchor;
          BOOL DOUPPER;
          INT fln;


          USECUSTOMZT = FALSE;
          if( ulMenuId == ID_CZIPFOL )
             {
             if( WinDlgBox(HWND_DESKTOP,
                                HWND_DESKTOP,
                                cztProc,
                                hResource,
                                ID_CZTDLG, (PVOID)2) )
                {
                USECUSTOMZT = TRUE;
                }
             else
                break;
             }

          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          if( !ZFOLINPROGRESS )
             {
             ZFOLINPROGRESS = TRUE;
             }
          else
             break;

          rsize = sizeof(dTopFold);
          _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                    DTOP, &dtopsize, TRUE);

          strcpy(dTop, DTOP);
          if( DTOP[strlen(DTOP)-1] != '\\' )
             strcat(dTop, "\\");

          _wpQueryRealName(somSelf, dTopFold, &rsize, TRUE);

          setINI();

          if( !chkValidDPStr(DFSTR) )
             {
             DosBeep(1200, 50);
             strcpy(DFSTR, DFAULTDESTZ);
             queryZZSet();
             saveZZSet();
             }


          tstr = _wpQueryTitle(somSelf);
          sprintf(foldName, "%s", tstr);

          strcpy(fqZipFile, "\"");
          if( USECUSTOMZT )
             {
             strcat(fqZipFile, CDFSTR);
             if( CDFSTR[strlen(CDFSTR)-1] != '\\' )
                strcat(fqZipFile, "\\");
             }
          else
             {
             strcat(fqZipFile, DFSTR);
             if( DFSTR[strlen(DFSTR)-1] != '\\' )
                strcat(fqZipFile, "\\");
             }
          strcat(fqZipFile, foldName);
          DOUPPER = FALSE;
          for( fln=0;fln<strlen(foldName);fln++ )
             {
             if( (UINT)foldName[fln] > 64 && (UINT)foldName[fln] < 91 )
                DOUPPER = TRUE;
             }
          if( DOUPPER )
             strcat(fqZipFile, ".ZIP");
          else
             strcat(fqZipFile, ".zip");
          strcat(fqZipFile, "\"");
          if( USECUSTOMZT )
             {
             if( strlen(czipArgs) > 0 )
                {
                strcpy(pgmInputs, czipArgs);
                strcat(pgmInputs, " -S -j ");
                }
             else
                strcpy(pgmInputs, "-S -j ");
             }
          else
             {
             if( strlen(zipArgs) > 0 )
                {
                strcpy(pgmInputs, zipArgs);
                strcat(pgmInputs, " -S -j ");
                }
             else
                strcpy(pgmInputs, "-S -j ");
             }
          if( strlen(noeas) > 0 )
             strcat(pgmInputs, noeas);
          strcat(pgmInputs, fqZipFile);
          strcat(pgmInputs, " ");
          strcat(pgmInputs, "\"");
          strcat(pgmInputs, dTopFold);
          strcat(pgmInputs, "\\*");
          strcat(pgmInputs, "\"");

          if( USECUSTOMZT )
             strcpy(destPath, CDFSTR);
          else
             strcpy(destPath, DFSTR);

          if( stricmp(destPath, DTOP) == 0 )
             {
             }
          else
             {
             INT f;

             makeFolders(destPath);

             if( destPath[strlen(destPath) - 1] == '\\' )
                {
                CHAR tmpS[ZZMAXPATH];

                strcpy(tmpS, destPath);
                tmpS[strlen(destPath)-1] = '\0';
                hobj = WinQueryObject(tmpS);
                }
             else
                {
                hobj = WinQueryObject(destPath);
                strcat(destPath, "\\");
                }
             if( pgmData[46] )
                makeShadow(destPath, "<WP_DESKTOP>");
             }

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;

          WinRegisterClass (habAnchor, obc, zfolProc, 0, 0);

          hwndZFOL = WinCreateWindow(HWND_OBJECT,
                                                      obc,
                                                      NULL,
                                                      0,
                                                      0,
                                                      0,
                                                      0,
                                                      0,
                                                      HWND_OBJECT,
                                                      HWND_BOTTOM,
                                                      0L,
                                                      (PVOID)NULL,
                                                      (PVOID)NULL);

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap ZIPS!";
          pDetails.pszExecutable   = "zip.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = "";
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = hwndZFOL;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          if( WinStartApp(hwndZFOL, &pDetails, pgmInputs, NULL, 1) == 0 )
             {
             ZFOLINPROGRESS = FALSE;
             WinDestroyWindow(hwndZFOL) ;
             }
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          break;
          }

       case ID_ZIPTRE:
       case ID_SZIPTRE:
       case ID_CZIPTRE:
          {
          HOBJECT hobj;
          INT i, lastS;
          CHAR dTopFold[ZZMAXPATH];
          CHAR fqZipFile[ZZMAXPATH];
          ULONG rsize = sizeof(dTopFold);
          PROGDETAILS  pDetails;
          CHAR dTop[ZZMAXPATH];
          ULONG flgs;
          CHAR foldName[ZZMAXPATH];
          CHAR pgmInputs[ZZMAXPATH];
          SOMAny *fol;
          CHAR upStr[ZZMAXPATH];
          CHAR destPath[ZZMAXPATH];
          PSZ tstr;
          CHAR obc[] = "zfolObjectClass";
          HAB  habAnchor;
          BOOL DOUPPER;
          INT fln;


          USECUSTOMZT = FALSE;
          if( ulMenuId == ID_CZIPTRE )
             {
             if( WinDlgBox(HWND_DESKTOP,
                                HWND_DESKTOP,
                                cztProc,
                                hResource,
                                ID_CZTDLG, (PVOID)3) )
                {
                USECUSTOMZT = TRUE;
                }
             else
                break;
             }

          if( pgmData[57] && (WinGetKeyState(HWND_DESKTOP, VK_F11)&0x8000) )
             strcpy(noeas, " -X ");
          else
             strcpy(noeas, "");

          if( !ZFOLINPROGRESS )
             {
             ZFOLINPROGRESS = TRUE;
             }
          else
             break;

          _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                                    DTOP, &dtopsize, TRUE);

          strcpy(dTop, DTOP);
          if( DTOP[strlen(DTOP)-1] != '\\' )
             strcat(dTop, "\\");

          _wpQueryRealName(somSelf, dTopFold, &rsize, TRUE);

          setINI();

          if( !chkValidDPStr(DFSTR) )
             {
             DosBeep(1200, 50);
             strcpy(DFSTR, DFAULTDESTZ);
             queryZZSet();
             saveZZSet();
             }

          tstr = _wpQueryTitle(somSelf);
          sprintf(foldName, "%s", tstr);

          strcpy(fqZipFile, "\"");
          if( USECUSTOMZT )
             {
             strcat(fqZipFile, CDFSTR);
             if( CDFSTR[strlen(CDFSTR)-1] != '\\' )
                strcat(fqZipFile, "\\");
             }
          else
             {
             strcat(fqZipFile, DFSTR);
             if( DFSTR[strlen(DFSTR)-1] != '\\' )
                strcat(fqZipFile, "\\");
             }
          strcat(fqZipFile, foldName);
          DOUPPER = FALSE;
          for( fln=0;fln<strlen(foldName);fln++ )
             {
             if( (UINT)foldName[fln] > 64 && (UINT)foldName[fln] < 91 )
                DOUPPER = TRUE;
             }
          if( DOUPPER )
             strcat(fqZipFile, ".ZIP");
          else
             strcat(fqZipFile, ".zip");
          strcat(fqZipFile, "\"");
          if( USECUSTOMZT )
             {
             if( strlen(czipArgs) > 0 )
                {
                strcpy(pgmInputs, czipArgs);
                strcat(pgmInputs, " -r -S ");
                }
             else
                strcpy(pgmInputs, "-r -S ");
             }
          else
             {
             if( strlen(zipArgs) > 0 )
                {
                strcpy(pgmInputs, zipArgs);
                strcat(pgmInputs, " -r -S ");
                }
             else
                strcpy(pgmInputs, "-r -S ");
             }
          if( strlen(noeas) > 0 )
             strcat(pgmInputs, noeas);
          strcat(pgmInputs, fqZipFile);
          strcat(pgmInputs, " ");
          strcat(pgmInputs, ".\\*");

          if( USECUSTOMZT )
             strcpy(destPath, CDFSTR);
          else
             strcpy(destPath, DFSTR);

          if( stricmp(destPath, DTOP) == 0 )
             {
             }
          else
             {
             INT f;

             for( f=0;f<strlen(destPath);f++ )
                {
                if( destPath[f] == '\\' )
                   {
                   CHAR tmpPath[ZZMAXPATH];

                   strncpy(tmpPath, destPath, f);
                   tmpPath[f] = '\0';
                   mkdir(tmpPath);
                   }
                }
             mkdir(destPath);
             if( destPath[strlen(destPath) - 1] == '\\' )
                {
                CHAR tmpS[ZZMAXPATH];

                strcpy(tmpS, destPath);
                tmpS[strlen(destPath)-1] = '\0';
                hobj = WinQueryObject(tmpS);
                }
             else
                {
                hobj = WinQueryObject(destPath);
                strcat(destPath, "\\");
                }
             if( pgmData[46] )
                makeShadow(destPath, "<WP_DESKTOP>");
             }

          WinRegisterClass (habAnchor, obc, zfolProc, 0, 0);

          hwndZFOL = WinCreateWindow(HWND_OBJECT,
                                                      obc,
                                                      NULL,
                                                      0,
                                                      0,
                                                      0,
                                                      0,
                                                      0,
                                                      HWND_OBJECT,
                                                      HWND_BOTTOM,
                                                      0L,
                                                      (PVOID)NULL,
                                                      (PVOID)NULL);

          if( pgmData[43] && !pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
          if( !pgmData[43] && pgmData[44] )
             flgs = SWP_HIDE;
          if( !pgmData[43] && !pgmData[44] )
             flgs = SWP_HIDE | SWP_NOAUTOCLOSE;
          if( pgmData[43] && pgmData[44] )
             flgs = SWP_ACTIVATE | SWP_SHOW;

          pDetails.Length          = sizeof(PROGDETAILS);
          pDetails.progt.progc     = PROG_DEFAULT;
          pDetails.progt.fbVisible = SHE_VISIBLE;
          pDetails.pszTitle        = "ZipZap ZIPS!";
          pDetails.pszExecutable   = "zip.exe";
          pDetails.pszParameters   = pgmInputs;
          pDetails.pszStartupDir   = dTopFold;
          pDetails.pszIcon         = "";
          pDetails.pszEnvironment  = "";
          pDetails.swpInitial.fl   = flgs;
          pDetails.swpInitial.cy   = 0;
          pDetails.swpInitial.cx   = 0;
          pDetails.swpInitial.y    = 0;
          pDetails.swpInitial.x    = 0;
          pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
          pDetails.swpInitial.hwnd             = hwndZFOL;
          pDetails.swpInitial.ulReserved1      = 0;
          pDetails.swpInitial.ulReserved2      = 0;

          if( WinStartApp(hwndZFOL, &pDetails, pgmInputs, NULL, 1) == 0 )
             {
             ZFOLINPROGRESS = FALSE;
             WinDestroyWindow(hwndZFOL) ;
             }
          _beginthread(payUp, NULL, ZZSTACKSIZE, (PVOID)0);
          break;
          }

       default:
          result = zipzapfolder_parent_WPFolder_wpMenuItemSelected(somSelf,
                                                                                          hwndFrame,
                                                                                          ulMenuId);
                                                                                          
          break;
       }
    */ 

    result = zipzapfolder_parent_WPFolder_wpMenuItemSelected(somSelf,
                                                                                         hwndFrame,
                                                                                         ulMenuId);
    return(result);
}






SOM_Scope HWND  SOMLINK zipzapfolderX_wpOpen(zipzapfolder *somSelf,
                                             HWND hwndCnr, ULONG ulView,
                                             ULONG param)
{
    HWND hwndFold;

    zipzapfolderData *somThis = zipzapfolderGetData(somSelf);
    zipzapfolderMethodDebug("zipzapfolder","zipzapfolderX_wpOpen");

    hwndFold = zipzapfolder_parent_WPFolder_wpOpen(somSelf, hwndCnr,
                                                                             ulView, param);
    /*   
    if(_somIsA(somSelf, _WPDesktop))
       {
       if( OPENONCE == 0 )
          {
          _beginthread(setINITH, NULL, ZZSTACKSIZE, (PVOID)0);
          _beginthread(aboutDlg, NULL, ZZSTACKSIZE, (PVOID)1);
          _getcwd(INSTALLDIR, sizeof(INSTALLDIR));
          if( INSTALLDIR[strlen(INSTALLDIR)-1] != '\\' )
             strcat(INSTALLDIR, "\\");
          strcpy(fileicon, INSTALLDIR);
          strcpy(exeicon, INSTALLDIR);
          strcpy(zipicon, INSTALLDIR);
          strcpy(foldicon, INSTALLDIR);
          strcat(fileicon, "filef.ico");
          strcat(exeicon, "exef.ico");
          strcat(zipicon, "zipf.ico");
          strcat(foldicon, "foldf.ico");
          }
       OPENONCE++;
       }
    */
     
    return(hwndFold);
}







SOM_Scope void  SOMLINK zipzapfolderX_wpclsInitData(M_zipzapfolder *somSelf)
{
    CHAR     szBuffer[BUFFERSIZE];


    M_zipzapfolderData *somThis = M_zipzapfolderGetData(somSelf);
    M_zipzapfolderMethodDebug("M_zipzapfolder","zipzapfolderX_wpclsInitData");


    if( hResource == NULLHANDLE )
       DosLoadModule(szBuffer,
                            BUFFERSIZE,
                            RESOURCE_MODULE,
                            &hResource);

    ZTINPROGRESS = FALSE;
    UZMINPROGRESS = FALSE;
    ZFOLINPROGRESS = FALSE;
    UZEXEINPROGRESS = FALSE;
    DRPINPROGRESS = FALSE;
    strcpy(defZipFile, "");
    CHECKMOD = TRUE;
    OPENONCE = 0;

    M_zipzapfolder_parent_M_WPFolder_wpclsInitData(somSelf);
}







/*
 * pszMyTitle:   noget, noset;
 */

SOM_Scope void  SOMLINK zipzapfolderX_wpclsUnInitData(M_zipzapfolder *somSelf)
{
    M_zipzapfolderData *somThis = M_zipzapfolderGetData(somSelf);
    M_zipzapfolderMethodDebug("M_zipzapfolder","zipzapfolderX_wpclsUnInitData");


    // if( hResource != NULLHANDLE )
    //    DosFreeModule( hResource );

    M_zipzapfolder_parent_M_WPFolder_wpclsUnInitData(somSelf);
}









//****************************************************************
//****************************************************************
//****************************************************************
//*********************** Extra Routines ****************************
//****************************************************************
//****************************************************************






VOID _Optlink noBytes(PVOID n)
{
HAB        habAnchor ;
HMQ        hmqQueue ;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);


msgBox(HWND_DESKTOP, "Attention!", "This file has NO bytes in it!");


WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
return ;
}





VOID _Optlink noFiles(PVOID n)
{
HAB        habAnchor ;
HMQ        hmqQueue ;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);


msgBox(HWND_DESKTOP, "Attention!", "This ZIP file has nothing in it!");


WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
return ;
}





VOID _Optlink setINITH(PVOID n)
{
HAB        habAnchor ;
HMQ        hmqQueue ;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);


setINI();
queryZZSet();
saveZZSet();


WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
return ;
}





VOID _Optlink viewZipOnDClick(PVOID vobj)
{
HAB habT;
HMQ hmqT;
HWND hwndD, hwndF;
PROGDETAILS  pDetails;
CHAR pgmInputs[ZZMAXPATH];
CHAR fqTmpFile[ZZMAXPATH];
CHAR selfName[ZZMAXPATH];
ULONG ssize = sizeof(selfName);
CHAR fqselfName[ZZMAXPATH];
ULONG fqssize = sizeof(fqselfName);
CHAR tmpPath[] = " :\\OS2";
CHAR tmpFile[ZZMAXPATH];
SOMAny *ss;
STARTDATA   StartData;
ULONG       SessID;
PID         PID;
CHAR       title[20];
CHAR       ObjBuf[100];
ULONG flgs;
HAB  habAnchor;
CHAR myclass[] = "showZIPClass";
PSZ                   szQueueName  = "\\QUEUES\\SHOWZIP.QUE";
HQUEUE              hqSpecialQue = NULLHANDLE;
PSZ                   DataBuffer   = "";
REQUESTDATA    rquest       = {0};
ULONG                ulDataLen    = 0;
BYTE                 ElemPrty     = 0;
APIRET              rc           = NO_ERROR;



habT = WinInitialize(0);
hmqT = WinCreateMsgQueue(habT, 0);
WinCancelShutdown(hmqT, TRUE);

ss = (SOMAny *)vobj;

_wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                            DTOP, &dtopsize, TRUE);

setINI();

if( !pgmData[25] )
   {
   tmpPath[0] = DTOP[0];
   if( stricmp(nzShowCEdit, "E.EXE") == 0 )
      {
      strcpy(nzShowCEdit, tmpPath);
      strcat(nzShowCEdit, "\\E.EXE");
      saveZZSet();
      }

   _wpQueryRealName(ss, fqselfName, &fqssize, TRUE);
   _wpQueryRealName(ss, selfName, &ssize, FALSE);
   strcpy(ZIPNAME, selfName);

   strcpy(tmpFile, selfName);
   tmpFile[strlen(tmpFile)-3] = 'N';
   tmpFile[strlen(tmpFile)-2] = 'F';
   tmpFile[strlen(tmpFile)-1] = '0';
   strcpy(fqTmpFile, tmpPath);
   strcat(fqTmpFile, "\\");
   strcat(fqTmpFile, tmpFile);
   strcpy(TFNAME, fqTmpFile);


   strcpy(pgmInputs, "/C unzip -l ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, fqselfName);
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, " > ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, tmpPath);
   strcat(pgmInputs, "\\");
   strcat(pgmInputs, tmpFile);
   strcat(pgmInputs, "\"");

   flgs = SWP_HIDE | SWP_MINIMIZE;

   rc = DosCreateQueue(&hqSpecialQue, QUE_FIFO | QUE_CONVERT_ADDRESS,  szQueueName);

   StartData.Length = sizeof(STARTDATA);
   StartData.Related = SSF_RELATED_CHILD;
   StartData.FgBg = SSF_FGBG_BACK;
   StartData.TraceOpt = SSF_TRACEOPT_NONE;
   strcpy(title,"");
   StartData.PgmTitle = title;
   StartData.PgmName = "cmd.exe";
   StartData.PgmInputs = pgmInputs;
   StartData.TermQ = szQueueName;
   StartData.Environment = 0;
   StartData.InheritOpt = SSF_INHERTOPT_PARENT;
   StartData.SessionType = SSF_TYPE_WINDOWABLEVIO;
   StartData.IconFile = 0;
   StartData.PgmHandle = 0;
   StartData.PgmControl = SSF_CONTROL_INVISIBLE | SSF_CONTROL_MINIMIZE;
   StartData.InitXPos = 0;
   StartData.InitYPos = 0;
   StartData.InitXSize = 0;
   StartData.InitYSize = 0;
   StartData.Reserved = 0;
   StartData.ObjectBuffer = ObjBuf;
   StartData.ObjectBuffLen = sizeof(ObjBuf);

   rc = DosStartSession(&StartData, &SessID, &PID);


   if (rc != 0)
      {
      // Failed!
      WinDestroyMsgQueue(hmqT);
      WinTerminate(habT);
     _endthread();
      return;
      }

   rc = DosOpenQueue (&PID, &hqSpecialQue, szQueueName);

   if (rc!= NO_ERROR)
      {
      WinDestroyMsgQueue(hmqT);
      WinTerminate(habT);
     _endthread();
      return;
      }

   DataBuffer = "";
   rquest.pid = PID;

   rc = DosReadQueue (hqSpecialQue,
                                &rquest,
                                &ulDataLen,
                                (PVOID) &DataBuffer,
                                0L,
                                DCWW_WAIT,
                                &ElemPrty,
                                0L);

   if (rc!= NO_ERROR)
      {
      WinDestroyMsgQueue(hmqT);
      WinTerminate(habT);
     _endthread();
      return;
      }

   rc = DosCloseQueue(hqSpecialQue);

   if (rc!= NO_ERROR)
      {
      WinDestroyMsgQueue(hmqT);
      WinTerminate(habT);
     _endthread();
      return;
      }

   // DosSleep(5000);
   hwndF = WinLoadDlg(HWND_DESKTOP,
                                 HWND_DESKTOP,
                                 contviewProc,
                                 hResource,
                                 ID_CONTVIEW, (PVOID)0);

   WinProcessDlg(hwndF);
   DosDelete(fqTmpFile);

   }
else
   {
   if( strlen(nzExtZipView) == 0 )
      return;

   _wpQueryRealName(ss, fqselfName, &fqssize, TRUE);
   _wpQueryRealName(ss, selfName, &ssize, FALSE);

   strcpy(pgmInputs, "\"");
   strcat(pgmInputs, fqselfName);
   strcat(pgmInputs, "\"");

   flgs = SWP_ACTIVATE | SWP_SHOW;

   pDetails.Length          = sizeof(PROGDETAILS);
   pDetails.progt.progc     = PROG_DEFAULT;
   pDetails.progt.fbVisible = SHE_VISIBLE;
   pDetails.pszTitle        = fqselfName;
   pDetails.pszExecutable   = nzExtZipView;
   pDetails.pszParameters   = pgmInputs;
   pDetails.pszStartupDir   = "";
   pDetails.pszIcon         = "";
   pDetails.pszEnvironment  = "";
   pDetails.swpInitial.fl   = flgs;
   pDetails.swpInitial.cy   = 0;
   pDetails.swpInitial.cx   = 0;
   pDetails.swpInitial.y    = 0;
   pDetails.swpInitial.x    = 0;
   pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
   pDetails.swpInitial.hwnd             = NULLHANDLE;
   pDetails.swpInitial.ulReserved1      = 0;
   pDetails.swpInitial.ulReserved2      = 0;

   WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, 1);
   }


WinDestroyMsgQueue(hmqT);
WinTerminate(habT);
_endthread();
}





INT viewOnContDClick(HWND hwndF, CHAR *fn, CHAR *zn, CHAR *foldn, INT level)
{
INT levelnum;


levelnum = level;
// debugMsgInt(levelnum, "level yyy");
strcpy(TFNAME, fn);
strcpy(ZIPNAME, zn);
strcpy(FOLDNAME, foldn);
hwndF = WinLoadDlg(HWND_DESKTOP,
                              hwndF,
                              contviewProc,
                              hResource,
                              ID_CONTVIEW, (PVOID)levelnum);

WinProcessDlg(hwndF);
lastlevelnum--;

return(1);
}





MRESULT EXPENTRY contviewProc(HWND hwndDlg, ULONG msg,
                                                 MPARAM mp1, MPARAM mp2 )
{
PSWP pswp;
PSWP pNewSize;

pNewSize = (PSWP)mp1;
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;
      INT levelnum;


      CONTBUSY = FALSE;
      levelnum = (INT)PVOIDFROMMP(mp2) ;
      lastlevelnum = levelnum;
      oldContProc = WinSubclassWindow(WinWindowFromID(hwndDlg, ID_CONTOBJ), newContProc);
      WinSetWindowPtr(WinWindowFromID(hwndDlg, ID_CONTOBJ), 0, (PVOID) oldContProc);
      oldPointer = WinQueryPointer(HWND_DESKTOP);
      newPointer = WinQuerySysPointer(HWND_DESKTOP, SPTR_WAIT, FALSE);
      hsbwidth = (USHORT) WinQuerySysValue (HWND_DESKTOP, SV_CYHSCROLL);
      vsbwidth = (USHORT) WinQuerySysValue (HWND_DESKTOP, SV_CXVSCROLL);
      mmbheight = (USHORT) WinQuerySysValue (HWND_DESKTOP, SV_CYMINMAXBUTTON);
      borderwidth = (USHORT) WinQuerySysValue (HWND_DESKTOP, SV_CXSIZEBORDER);
      WinSetParent(WinWindowFromID(hwndDlg, ID_CONTOBJ), hwndDlg, TRUE);
      WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );

      // CONTBUSY = TRUE;
      WinEnableWindowUpdate(WinWindowFromID(hwndDlg, ID_CONTOBJ),FALSE);
      // debugMsgInt(levelnum, "levelnum xxx");
      if( levelnum == 0 )
         insertCont(hwndDlg, TFNAME, ZIPNAME);
      else   
         insertContX(hwndDlg, TFNAME, ZIPNAME, levelnum);
      WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                  CM_ARRANGE, 0,0);
      WinEnableWindowUpdate(WinWindowFromID(hwndDlg, ID_CONTOBJ),TRUE);
      // CONTBUSY = FALSE;
      }
      break;

   /*
   case WM_DESTROY :
      {
      lastlevelnum--;
      }
      break;
   */
      
   case WM_CONTROL :
      switch (SHORT1FROMMP(mp1)) 
         {
         case ID_CONTOBJ:
            {
            switch (SHORT2FROMMP(mp1)) 
               {
               case CN_ENTER:
                  {
                  PCHAR p ;
                  CHAR szWindow[ 20] ;
                  PNOTIFYRECORDENTER pNotRecEnter ;
                  PRECORDCORE prec ;
                  HWND hwndClient, hwndSelected ;


                  pNotRecEnter = (PNOTIFYRECORDENTER)mp2 ;
                  if( pNotRecEnter -> pRecord)
                     {
                     CHAR *ss;
                     
                     prec = (PRECORDCORE)pNotRecEnter ->pRecord;
                     ss = strstr(prec->pszIcon, "bytes]");
                     if( !ss )
                        {
                        viewOnContDClick(hwndDlg, TFNAME, ZIPNAME, prec->pszIcon, lastlevelnum+1);
                        // _beginthread(viewZipOnDClick, NULL, ZZSTACKSIZE, (PVOID)somSelf);
                        // debugMsgStr(prec->pszIcon, "prec->pszIcon");
                        }
                     }
               
                  // prec = (PRECORDCORE)pNotRecEnter -> pRecord ;

                  // application client window
                  // hwndClient = OWNER( hwnd) ;

                  // strcpy( szWindow, prec -> pszText) ;
                  // p = strchr( szWindow, ' ') ;
                  // *p = '\0' ;
                  // trasform the HEX string into an HWND
                  // sscanf( szWindow, "%lx", (PHWND)&hwndSelected) ;
                  // create the info panel
                  //  CheckWindow( hwndClient, hwndSelected) ;
                  }
                  break;

               case CN_INITDRAG:
                  {
                  }
                  break;

               case CN_DRAGOVER:
                  {
                  return MRFROM2SHORT(DOR_NODROPOP, DO_DEFAULT);
                  }
                  break;
               }   
            }
            break;
         } 
      break;

   case WM_MOUSEMOVE :
      if ( CONTBUSY )
	 {
	 WinSetPointer(HWND_DESKTOP, newPointer);
	 return(MRESULT)TRUE;
	 }
      else
	 return (WinDefDlgProc(hwndDlg, msg, mp1, mp2));

   case WM_WINDOWPOSCHANGED:
      {
      SWP swp;

      if( pNewSize->fl & SWP_SIZE )
         {
         WinQueryWindowPos(hwndDlg, (PSWP) &swp);
         WinSetWindowPos(WinWindowFromID(hwndDlg, ID_CONTOBJ), (HWND)0,
                                    0, 0, swp.cx-(2*borderwidth), swp.cy-((2*borderwidth)+mmbheight), SWP_SIZE);
         }
      }	
      return (WinDefDlgProc(hwndDlg, msg, mp1, mp2));

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}





MRESULT EXPENTRY newContProc(HWND hwndWnd, ULONG ulMsg,
                                                 MPARAM mp1, MPARAM mp2 )
{
PFNWP oldWinProc;

oldWinProc = (PFNWP) WinQueryWindowPtr(hwndWnd, 0);
switch(ulMsg)
   {
   case WM_MOUSEMOVE :
      if ( CONTBUSY )
         {
         newPointer = WinQuerySysPointer(HWND_DESKTOP, SPTR_WAIT, FALSE);
         WinSetPointer(HWND_DESKTOP, newPointer);
         return(MRESULT)TRUE;
         }
      else
         return (WinDefDlgProc(hwndWnd, ulMsg, mp1, mp2));

   default :
      break;
   }
return( *oldWinProc ) (hwndWnd, ulMsg, mp1, mp2);
}





INT insertCont(HWND hwndDlg, CHAR *fname, CHAR *zname)
{
HFILE fhan, fhanTMP;
APIRET rc, rcTMP;
INT i, k, dlen;
ULONG act, actTMP, rd, local, slen, wheat;
CHAR fline[ZZMAXPATH] = "";
CHAR wrline[ZZMAXPATH];
CHAR nline[] = "\x0a";
CHAR dline[] = "\x0d";
BOOL DONE, DOIT, NEXTONE, NEWONE;
INT linenum;
CHAR name[ZZMAXPATH];
CHAR tmpname[ZZMAXPATH];
CHAR title[ZZMAXPATH];
CHAR *result;



WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), "loading zipfile data ...");
rc = DosOpen(fname, &fhan, &act, 0L, 0L,
                   OPEN_ACTION_FAIL_IF_NEW |
                   OPEN_ACTION_OPEN_IF_EXISTS,
                   OPEN_FLAGS_NOINHERIT |
                   OPEN_ACCESS_READONLY |
                   OPEN_SHARE_DENYNONE, 0L);
                   
if (rc != 0 )
   {
   DosClose(fhan);
   debugMsgStr(fname, "Failed to open!");
   }
else
   {
   DOIT = FALSE;
   DONE = FALSE;
   NEXTONE = FALSE;
   linenum = 0;
   strcpy(tmpname, "");
   do
      {
      fline[0] = '\0';
      k = 0;
      do
         {
         DosRead(fhan, fline+k, sizeof(fline[0]), &rd);
         if( fline[k] != '\n' )
            {
            k++;
            }
         }
      while( rd > 0 && fline[k] != '\n' );
      fline[k] = '\0';

      fline[strlen(fline)-1] = '\0';
      slen = strlen(fline);
      
      if( NEXTONE )
         {
         INT tlen;
         
         k = slen;
         do
            {
            k--;
            }
         while(fline[k] != ' ' && k > 0);
         do
            {
            k--;
            }
         while(fline[k] != ' ' && k > 0);
         strcpy(title, zname);
         strcat(title, "  ");
         strcat(title, fline+k+1);
         strcat(title, "  ");
         tlen = strlen(title);
         k = -1;
         do
            {
            k++;
            }
         while(fline[k] == ' ' && k < slen);
         if( k > 0 )
            strndel(fline, k);
         slen = strlen(fline);   
         k = -1;   
         do
            {
            k++;
            }
         while(fline[k] != ' ' && k < slen);
         strncat(title, fline, k);
         strcat(title, " bytes");
         
         WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), title);
         NEXTONE = FALSE;
         }

      if( slen == 48  && strcmp(fline,  " ------  -----  -----                    -------") == 0 )
         {
         DOIT = FALSE;
         NEXTONE = TRUE;
         }
         
      if( rd > 0 && DOIT  )
         {
         PMAIN_1000_REC pRecord; 
         RECORDINSERT RecordInsert;
         INT nlen;


         k = slen;
         do
            {
            k--;
            }
         while( fline[k] != ':' && k > 0);
         
         strcpy(name, fline+k+6);
         nlen = strlen(name);

         pRecord=(PVOID)WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                                            CM_ALLOCRECORD,
                                                            MPFROMLONG(sizeof(*pRecord)-sizeof(MINIRECORDCORE)+32), 
                                                            MPFROMLONG(1));                  
         pRecord->Record.cb=sizeof(MINIRECORDCORE);
         pRecord->Record.flRecordAttr=0;

         result = NULL;  
         result = strstr(name, "/");
         if( result )
            {
            if( strlen(tmpname) > 0 )
               {
               k = 0;
               do
                  {
                  k++;
                  }
               while(name[k] != '/' && k < nlen);
               // name[k] = '\0';
               if( strncmp(tmpname, name, k) != 0 )
                  {
                  NEWONE = TRUE;
                  strncpy(tmpname, name, k);
                  tmpname[k] = '\0';
                  }
               else
                  NEWONE = FALSE;   
               }
            else
               {
               k = 0;
               do
                  {
                  k++;
                  }
               while(name[k] != '/' && k < nlen);
               NEWONE = TRUE;   
               strncpy(tmpname, name, k);
               tmpname[k] = '\0';
               }
            if( NEWONE )
               {
               pRecord->Record.hptrIcon=WinLoadFileIcon(foldicon, FALSE);
               pRecord->Record.pszIcon=(PBYTE)pRecord+sizeof(*pRecord);
        
               strcpy(pRecord->Record.pszIcon, tmpname);
            
               RecordInsert.cb=sizeof(RECORDINSERT);
               RecordInsert.pRecordOrder=(PRECORDCORE)CMA_END; 
               RecordInsert.pRecordParent=(PRECORDCORE)0;     
               RecordInsert.zOrder=CMA_TOP;
               RecordInsert.cRecordsInsert=1;
               RecordInsert.fInvalidateRecord=TRUE;           
               WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                           CM_INSERTRECORD,
                                           MPFROMP(pRecord),
                                           MPFROMP(&RecordInsert));
               }
            }
         else
            {  
            if( nlen > 4 )
               {
               if( strcmpi(name + (strlen(name) - 4), ".EXE") == 0  ||
                   strcmpi(name + (strlen(name) - 4), ".COM") == 0 ||
                   strcmpi(name + (strlen(name) - 4), ".CMD") == 0 )
                  {
                  pRecord->Record.hptrIcon=WinLoadFileIcon(exeicon, FALSE);
                  }
               else
                  {
                  if( strcmpi(name + (strlen(name) - 4), ".ZIP") == 0 )
                     pRecord->Record.hptrIcon=WinLoadFileIcon(zipicon, FALSE);
                  else    
                     pRecord->Record.hptrIcon=WinLoadFileIcon(fileicon, FALSE);
                  }    
               }
            else
               {
               pRecord->Record.hptrIcon=WinLoadFileIcon(fileicon, FALSE);
               }
                  
            pRecord->Record.pszIcon=(PBYTE)pRecord+sizeof(*pRecord);
         
            strcpy(title, fline);
            k = -1;
            do
               {
               k++;
               }
            while(title[k] == ' ' && k < slen);
            if( k > 0 )
               strndel(title, k);
            dlen = strlen(title);   
            k = -1;   
            do
               {
               k++;
               }
            while(title[k] != ' ' && k < dlen);
            title[k] = '\0';
            strcat(title, " bytes");
            strcat(name, "\n");
            strcat(name, "[");
            strcat(name, title);
            strcat(name, "]");
            
            strcpy(pRecord->Record.pszIcon, name);
         
            RecordInsert.cb=sizeof(RECORDINSERT);
            RecordInsert.pRecordOrder=(PRECORDCORE)CMA_END; 
            RecordInsert.pRecordParent=(PRECORDCORE)0;     
            RecordInsert.zOrder=CMA_TOP;
            RecordInsert.cRecordsInsert=1;
            RecordInsert.fInvalidateRecord=TRUE;           
            WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                     CM_INSERTRECORD,
                                     MPFROMP(pRecord),
                                     MPFROMP(&RecordInsert));
            }                         
         }
      else
         {
         }
      if( slen == 45  && strcmp(fline, " ------    ---   ----    ----    ----    ----") == 0 )
         DOIT = TRUE;
      linenum ++;
      }
   while(rd >0);
   }
DosClose(fhan);

return(1);
}






INT insertContX(HWND hwndDlg, CHAR *fname, CHAR *zname, INT level)
{
HFILE fhan, fhanTMP;
APIRET rc, rcTMP;
INT i, k, dlen;
ULONG act, actTMP, rd, local, slen, nlen, fnlen, wheat;
CHAR fline[ZZMAXPATH] = "";
CHAR wrline[ZZMAXPATH];
CHAR nline[] = "\x0a";
CHAR dline[] = "\x0d";
BOOL DONE, DOIT, NEWONE;
INT linenum;
CHAR name[ZZMAXPATH];
CHAR tmpname[ZZMAXPATH];
CHAR title[ZZMAXPATH];
CHAR fntmp[ZZMAXPATH];
CHAR *result, *resn;
INT h, g, v;
CHAR lnumstr[260]; 



// debugMsgInt(level, "level zzz");
// itoa(level, lnumstr, 10);
WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), "loading zipfile data ...");

rc = DosOpen(fname, &fhan, &act, 0L, 0L,
                   OPEN_ACTION_FAIL_IF_NEW |
                   OPEN_ACTION_OPEN_IF_EXISTS,
                   OPEN_FLAGS_NOINHERIT |
                   OPEN_ACCESS_READONLY |
                   OPEN_SHARE_DENYNONE, 0L);
                   
if (rc != 0 )
   {
   DosClose(fhan);
   debugMsgStr(fname, "Failed to open!");
   }
else
   {
   fnlen = strlen(FOLDNAME);
   DOIT = FALSE;
   DONE = FALSE;
   linenum = 0;
   strcpy(tmpname, "");
   do
      {
      fline[0] = '\0';
      k = 0;
      do
         {
         DosRead(fhan, fline+k, sizeof(fline[0]), &rd);
         if( fline[k] != '\n' )
            {
            k++;
            }
         }
      while( rd > 0 && fline[k] != '\n' );
      fline[k] = '\0';

      fline[strlen(fline)-1] = '\0';
      slen = strlen(fline);

      k = slen;
      do
         {
         k--;
         }
      while( fline[k] != ':' && k > 0);
         
      strcpy(name, fline+k+6);
      nlen = strlen(name);


      for( v=0;v<level-1;v++ )
         {
         k = 0;
         do
            {
            k++;
            }
         while(name[k] != '/' && k < nlen);
         strndel(name, k+1);
         nlen = strlen(name);
         }
           

      strcpy(fntmp, FOLDNAME);
      strcat(fntmp, "/");
      
      if( rd > 0 && DOIT && nlen > fnlen && strncmp(name, fntmp, fnlen+1) == 0  )
         {
         PMAIN_1000_REC pRecord; 
         RECORDINSERT RecordInsert;

          
         for( v=0;v<1;v++ )
            {
            k = 0;
            do
               {
               k++;
               }
            while(name[k] != '/' && k < nlen);
            strndel(name, k+1);
            nlen = strlen(name);
            }
         
           
         if( strstr(name, "/") != NULL )  
            {
            // if( strlen(tmpname) > 0 && tmpname[strlen(tmpname)-1] == '/' )
            if( strlen(tmpname) > 0 )
               {
               k = 0;
               do
                  {
                  k++;
                  }
               while(name[k] != '/' && k < nlen);
            
               if( strncmp(tmpname, name, k) != 0 )
                  {
                  NEWONE = TRUE;
                 strncpy(tmpname, name, k);
                  tmpname[k] = '\0';
                  }
               else
                  NEWONE = FALSE;   
               }
            else
               {
               k = 0;
               do
                  {
                  k++;
                  }
               while(name[k] != '/' && k < nlen);
               NEWONE = TRUE;   
               strncpy(tmpname, name, k);
               tmpname[k] = '\0';
               }
            if( NEWONE )
               {
               pRecord=(PVOID)WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                                                   CM_ALLOCRECORD,
                                                                   MPFROMLONG(sizeof(*pRecord)-sizeof(MINIRECORDCORE)+32), 
                                                                   MPFROMLONG(1));                  
               pRecord->Record.cb=sizeof(MINIRECORDCORE);
               pRecord->Record.flRecordAttr=0;
               pRecord->Record.hptrIcon=WinLoadFileIcon(foldicon, FALSE);
               pRecord->Record.pszIcon=(PBYTE)pRecord+sizeof(*pRecord);
         
               strcpy(pRecord->Record.pszIcon, tmpname);
           
               RecordInsert.cb=sizeof(RECORDINSERT);
               RecordInsert.pRecordOrder=(PRECORDCORE)CMA_END; 
               RecordInsert.pRecordParent=(PRECORDCORE)0;     
               RecordInsert.zOrder=CMA_TOP;
               RecordInsert.cRecordsInsert=1;
               RecordInsert.fInvalidateRecord=TRUE;           
               WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                           CM_INSERTRECORD,
                                           MPFROMP(pRecord),
                                           MPFROMP(&RecordInsert));
               }
            }   
         else
            {
            if( strlen(name) > 0 )
               {
            pRecord=(PVOID)WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                                                CM_ALLOCRECORD,
                                                                MPFROMLONG(sizeof(*pRecord)-sizeof(MINIRECORDCORE)+32), 
                                                                MPFROMLONG(1));                  
            pRecord->Record.cb=sizeof(MINIRECORDCORE);
            pRecord->Record.flRecordAttr=0;

            if( nlen > 4 )
               {
               if( strcmpi(name + (strlen(name) - 4), ".EXE") == 0  ||
                   strcmpi(name + (strlen(name) - 4), ".COM") == 0 ||
                   strcmpi(name + (strlen(name) - 4), ".CMD") == 0 )
                  {
                  pRecord->Record.hptrIcon=WinLoadFileIcon(exeicon, FALSE);
                  }
               else
                  {
                  if( strcmpi(name + (strlen(name) - 4), ".ZIP") == 0 )
                     pRecord->Record.hptrIcon=WinLoadFileIcon(zipicon, FALSE);
                  else    
                     pRecord->Record.hptrIcon=WinLoadFileIcon(fileicon, FALSE);
                  }    
               }
            else
               {
               pRecord->Record.hptrIcon=WinLoadFileIcon(fileicon, FALSE);
               }
                  
            pRecord->Record.pszIcon=(PBYTE)pRecord+sizeof(*pRecord);
         
            strcpy(title, fline);
            k = -1;
            do
               {
               k++;
               }
            while(title[k] == ' ' && k < slen);
            if( k > 0 )
               strndel(title, k);
            dlen = strlen(title);   
            k = -1;   
            do
               {
               k++;
               }
            while(title[k] != ' ' && k < dlen);
            title[k] = '\0';
            strcat(title, " bytes");
            strcat(name, "\n");
            strcat(name, "[");
            strcat(name, title);
            strcat(name, "]");
            
            strcpy(pRecord->Record.pszIcon, name);
           
            RecordInsert.cb=sizeof(RECORDINSERT);
            RecordInsert.pRecordOrder=(PRECORDCORE)CMA_END; 
            RecordInsert.pRecordParent=(PRECORDCORE)0;     
            RecordInsert.zOrder=CMA_TOP;
            RecordInsert.cRecordsInsert=1;
            RecordInsert.fInvalidateRecord=TRUE;           
            WinSendDlgItemMsg(hwndDlg, ID_CONTOBJ,
                                        CM_INSERTRECORD,
                                        MPFROMP(pRecord),
                                       MPFROMP(&RecordInsert));
            }   
            }   
         }
      else
         {
         }
      if( slen == 45  && strcmp(fline, " ------    ---   ----    ----    ----    ----") == 0 )
         DOIT = TRUE;
      linenum ++;
      }
   while(rd >0);
   }
DosClose(fhan);

WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), FOLDNAME);

return(1);
}





/*
VOID _Optlink viewZipOnDClick(PVOID vobj)
{
HAB habT;
HMQ hmqT;
HWND hwndD;
PROGDETAILS  pDetails;
ULONG flgs;
CHAR pgmInputs[ZZMAXPATH];
CHAR fqTmpFile[ZZMAXPATH];
CHAR selfName[ZZMAXPATH];
ULONG ssize = sizeof(selfName);
CHAR fqselfName[ZZMAXPATH];
ULONG fqssize = sizeof(fqselfName);
CHAR tmpPath[] = " :\\OS2";
CHAR tmpFile[ZZMAXPATH];
SOMAny *ss;



habT = WinInitialize(0);
hmqT = WinCreateMsgQueue(habT, 0);
WinCancelShutdown(hmqT, TRUE);

ss = (SOMAny *)vobj;

_wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                            DTOP, &dtopsize, TRUE);

setINI();

if( !pgmData[25] )
   {
   tmpPath[0] = DTOP[0];
   if( stricmp(nzShowCEdit, "E.EXE") == 0 )
      {
      strcpy(nzShowCEdit, tmpPath);
      strcat(nzShowCEdit, "\\E.EXE");
      saveZZSet();
      }

   _wpQueryRealName(ss, fqselfName, &fqssize, TRUE);
   _wpQueryRealName(ss, selfName, &ssize, FALSE);

   strcpy(fqTmpFile, fqselfName);
   fqTmpFile[strlen(fqTmpFile)-3] = 'N';
   fqTmpFile[strlen(fqTmpFile)-2] = 'F';
   fqTmpFile[strlen(fqTmpFile)-1] = '0';
   strcpy(tmpFile, selfName);
   tmpFile[strlen(tmpFile)-3] = 'N';
   tmpFile[strlen(tmpFile)-2] = 'F';
   tmpFile[strlen(tmpFile)-1] = '0';

   if( pgmData[26] )
      strcpy(pgmInputs, "/C unzip -v ");
   else
      strcpy(pgmInputs, "/C unzip -l ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, fqselfName);
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, " > ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, tmpPath);
   strcat(pgmInputs, "\\");
   strcat(pgmInputs, tmpFile);
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, "&");
   strcat(pgmInputs, nzShowCEdit);
   strcat(pgmInputs, " ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, tmpPath);
   strcat(pgmInputs, "\\");
   strcat(pgmInputs, tmpFile);
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, "&erase ");
   strcat(pgmInputs, "\"");
   strcat(pgmInputs, tmpPath);
   strcat(pgmInputs, "\\");
   strcat(pgmInputs, tmpFile);
   strcat(pgmInputs, "\"");

   if( getAppType(nzShowCEdit) == 4 )
      flgs = SWP_HIDE | SWP_MINIMIZE;
   else
      flgs = SWP_ACTIVATE | SWP_SHOW;

   pDetails.Length          = sizeof(PROGDETAILS);
   pDetails.progt.progc     = PROG_DEFAULT;
   pDetails.progt.fbVisible = SHE_VISIBLE;
   pDetails.pszTitle        = fqselfName;
   pDetails.pszExecutable   = "cmd.exe";
   pDetails.pszParameters   = pgmInputs;
   pDetails.pszStartupDir   = "";
   pDetails.pszIcon         = "";
   pDetails.pszEnvironment  = "";
   pDetails.swpInitial.fl   = flgs;
   pDetails.swpInitial.cy   = 0;
   pDetails.swpInitial.cx   = 0;
   pDetails.swpInitial.y    = 0;
   pDetails.swpInitial.x    = 0;
   pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
   pDetails.swpInitial.hwnd             = NULLHANDLE;
   pDetails.swpInitial.ulReserved1      = 0;
   pDetails.swpInitial.ulReserved2      = 0;

   if( WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, 1) != 0 )
      {
      // It worked OK
      }
   }
else
   {
   if( strlen(nzExtZipView) == 0 )
      return;

   _wpQueryRealName(ss, fqselfName, &fqssize, TRUE);
   _wpQueryRealName(ss, selfName, &ssize, FALSE);

   strcpy(pgmInputs, "\"");
   strcat(pgmInputs, fqselfName);
   strcat(pgmInputs, "\"");

   flgs = SWP_ACTIVATE | SWP_SHOW;

   pDetails.Length          = sizeof(PROGDETAILS);
   pDetails.progt.progc     = PROG_DEFAULT;
   pDetails.progt.fbVisible = SHE_VISIBLE;
   pDetails.pszTitle        = fqselfName;
   pDetails.pszExecutable   = nzExtZipView;
   pDetails.pszParameters   = pgmInputs;
   pDetails.pszStartupDir   = "";
   pDetails.pszIcon         = "";
   pDetails.pszEnvironment  = "";
   pDetails.swpInitial.fl   = flgs;
   pDetails.swpInitial.cy   = 0;
   pDetails.swpInitial.cx   = 0;
   pDetails.swpInitial.y    = 0;
   pDetails.swpInitial.x    = 0;
   pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
   pDetails.swpInitial.hwnd             = NULLHANDLE;
   pDetails.swpInitial.ulReserved1      = 0;
   pDetails.swpInitial.ulReserved2      = 0;

   WinStartApp( NULLHANDLE, &pDetails, pgmInputs, NULL, 1);
   }


WinDestroyMsgQueue(hmqT);
WinTerminate(habT);
_endthread();
}
*/





INT getAppType(CHAR *appName)
{
ULONG type;

if ( DosQueryAppType (appName, &type) != 0 )
   return(-1);
if (type & FAPPTYP_DOS)
   return(1);  /* DOS */
else if (type & (FAPPTYP_WINDOWSREAL | FAPPTYP_WINDOWSPROT |
	    FAPPTYP_WINDOWSPROT31))
   return(2);  /* WINDOWS */
else if (type & FAPPTYP_BOUND)
   return(3);  /* BOUND */
else if ((type & 7) == FAPPTYP_WINDOWAPI)
   return(4);  /* PM  */
else
   {
   if ( type & FAPPTYP_NOTWINDOWCOMPAT )
      return(6);  /* OS2 FULLSCREEN  */
   else
      return(5);  /* OS2 EXECUTABLE */
   }
}





MRESULT EXPENTRY ztProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 )
{
switch(ulMsg)
   {
   case WM_APPTERMINATENOTIFY :
      {
      SOMAny *ob;
      SOMAny *Object, *NextObj;
      ULONG ulSize = 0;


      if( pgmData[45] )
         {
         if( USECUSTOMZT )
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, CDFSTR);
         else
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, DFSTR);
         _wpViewObject(ob, NULLHANDLE, 1, 0);

         _wpQueryRealName(ob, NULL, &ulSize, TRUE);
         if( ulSize )
            {
            _wpPopulate(ob, NULLHANDLE, NULL, FALSE);
            Object = _wpQueryContent(ob, NULL, QC_FIRST);
            while( Object )
               {
               NextObj =  _wpQueryContent(ob, Object, QC_NEXT);
               _wpUnlockObject(Object);
               Object = NextObj;
               }
            }
         _wpRefresh(ob, OPEN_CONTENTS, 0);
         _wpUnlockObject(ob);
         }

      if( pgmData[55] )
         {
         if( pgmData[55] )
            DosBeep(2700, 100);
         }

      ZTINPROGRESS = FALSE;
      WinSendMsg(hwndA, WM_CLOSE, 0, 0);
      }
      break;

   default:
      return WinDefWindowProc (hwndA,
                                            ulMsg,
                                            mp1,
                                            mp2 );
   }
return(MRESULT)FALSE;
}





MRESULT EXPENTRY uzmProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 )
{
switch(ulMsg)
   {
   case WM_APPTERMINATENOTIFY :
      {
      SOMAny *ob;


      if( pgmData[7] )
         {
         if( USECUSTOMUZT )
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, CZDSTR);
         else
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, ZDSTR);
         _wpViewObject(ob, NULLHANDLE, 1, 0);
         _wpRefresh(ob, OPEN_CONTENTS, 0);
         _wpUnlockObject(ob);
         }

      if( pgmData[5] )
         {
         ob = _wpclsQueryObjectFromPath(_WPFileSystem, ZDSTRP);
         _wpViewObject(ob, NULLHANDLE, 1, 0);
         _wpRefresh(ob, OPEN_CONTENTS, 0);
         _wpUnlockObject(ob);
         }

      if( pgmData[30] )
         {
         if( pgmData[55] )
            DosBeep(2700, 100);
         }

      UZMINPROGRESS = FALSE;
      WinSendMsg(hwndA, WM_CLOSE, 0, 0);
      }
      break;

   default:
      return WinDefWindowProc (hwndA,
                                            ulMsg,
                                            mp1,
                                            mp2 );
   }
return(MRESULT)FALSE;
}






MRESULT EXPENTRY uzexeProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 )
{
switch(ulMsg)
   {
   case WM_APPTERMINATENOTIFY :
      {
      SOMAny *ob;
      CHAR cobj[ZZMAXPATH];


      if( pgmData[7] )
         {
         if( USECUSTOMUZT )
            {
            strcpy(cobj, CZDSTR);
            if( cobj[strlen(cobj)-1] != '\\' )
               strcat(cobj, "\\");
            strcat(cobj, EXEZIP);
            WinDestroyObject(WinQueryObject(cobj));
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, CZDSTR);
            }
         else
            {
            strcpy(cobj, ZDSTR);
            if( cobj[strlen(cobj)-1] != '\\' )
               strcat(cobj, "\\");
            strcat(cobj, EXEZIP);
            WinDestroyObject(WinQueryObject(cobj));
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, ZDSTR);
            }
         _wpViewObject(ob, NULLHANDLE, 1, 0);
         _wpRefresh(ob, OPEN_CONTENTS, 0);
         _wpUnlockObject(ob);
         }

      if( pgmData[30] )
         {
         if( pgmData[55] )
            DosBeep(2700, 100);
         }

      UZEXEINPROGRESS = FALSE;
      WinSendMsg(hwndA, WM_CLOSE, 0, 0);
      }
      break;

   default:
      return WinDefWindowProc (hwndA,
                                            ulMsg,
                                            mp1,
                                            mp2 );
   }
return(MRESULT)FALSE;
}






MRESULT EXPENTRY zfolProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 )
{
switch(ulMsg)
   {
   case WM_APPTERMINATENOTIFY :
      {
      SOMAny *ob;
      SOMAny *Object, *NextObj;
      ULONG ulSize = 0;


      if( pgmData[45] )
         {
         if( USECUSTOMZT )
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, CDFSTR);
         else
            ob = _wpclsQueryObjectFromPath(_WPFileSystem, DFSTR);
         _wpViewObject(ob, NULLHANDLE, 1, 0);
         // _wpRefresh(ob, OPEN_CONTENTS, 0);
         // _wpUnlockObject(ob);

         _wpQueryRealName(ob, NULL, &ulSize, TRUE);
         if( ulSize )
            {
            _wpPopulate(ob, NULLHANDLE, NULL, FALSE);
            Object = _wpQueryContent(ob, NULL, QC_FIRST);
            while( Object )
               {
               NextObj =  _wpQueryContent(ob, Object, QC_NEXT);
               _wpUnlockObject(Object);
               Object = NextObj;
               }
            }
         _wpRefresh(ob, OPEN_CONTENTS, 0);
         _wpUnlockObject(ob);
         }

      if( pgmData[55] )
         DosBeep(2700, 100);

       ZFOLINPROGRESS = FALSE;
      WinSendMsg(hwndA, WM_CLOSE, 0, 0);
      }
      break;

   default:
      return WinDefWindowProc (hwndA,
                                            ulMsg,
                                            mp1,
                                            mp2 );
   }
return(MRESULT)FALSE;
}





MRESULT EXPENTRY drpProc( HWND hwndA, ULONG ulMsg,
                              MPARAM mp1, MPARAM mp2 )
{
switch(ulMsg)
   {
   case WM_APPTERMINATENOTIFY :
      {
      CHAR fqCMDFile [] = " :\\os2\\zip_n";
      CHAR suff[] = "  .cmd";
      CHAR num[4];
      CHAR qnum[4];
      CHAR rnum[4];
      SOMAny *ob;


      fqCMDFile[0] = DTOP[0];
      if( (INT)setfnum < 10 )
         {
         itoa((INT)setfnum , num, 10);
         suff[0] = '0';
         suff[1] = num[0];
         }
      else
         {
         div_t res;

         res = div((INT)setfnum, 10);
         itoa(res.quot, qnum, 10);
         suff[0] = qnum[0];
         itoa(res.rem, rnum, 10);
         suff[1] = rnum[0];
         }
      strcat(fqCMDFile, suff);

      DosDelete(fqCMDFile);

      if( pgmData[33] )
         DosBeep(2700, 100);

      DRPINPROGRESS = FALSE;
      WinSendMsg(hwndA, WM_CLOSE, 0, 0);
      }
      break;

   default:
      return WinDefWindowProc (hwndA,
                                            ulMsg,
                                            mp1,
                                            mp2 );
   }
return(MRESULT)FALSE;
}




MRESULT EXPENTRY cuzexeProc(HWND hwndDlg, ULONG msg,
                                          MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


      WinSendDlgItemMsg(hwndDlg, ID_CUZEXEDEST,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(ZZMAXPATH,0),NULL);

      if( strlen( CZDSTR ) == 0 )
         {
         WinSetDlgItemText(hwndDlg, ID_CUZEXEDEST, ZDSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CUZEXEDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(ZDSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CUZEXEDEST));
         }
      else
         {
         WinSetDlgItemText(hwndDlg, ID_CUZEXEDEST, CZDSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CUZEXEDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(CZDSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CUZEXEDEST));
         }
       	
      WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_CUZEXECANCEL :
            WinDismissDlg(hwndDlg, FALSE);
            break;

         case ID_CUZEXEOK :
            {
            WinQueryDlgItemText(hwndDlg, ID_CUZEXEDEST, sizeof(CZDSTR), CZDSTR);
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;


         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}





MRESULT EXPENTRY cuztProc(HWND hwndDlg, ULONG msg,
                                          MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


      WinSendDlgItemMsg(hwndDlg, ID_CUZTARGS,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(60,0),NULL);

      if( strlen(CUNZIPARGS) == 0 )
         WinSetDlgItemText(hwndDlg, ID_CUZTARGS, UNZIPARGS);
      else
         WinSetDlgItemText(hwndDlg, ID_CUZTARGS, CUNZIPARGS);


      WinSendDlgItemMsg(hwndDlg, ID_CUZTDEST,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(ZZMAXPATH,0),NULL);

      if( strlen( CZDSTR ) == 0 )
         {
         WinSetDlgItemText(hwndDlg, ID_CUZTDEST, ZDSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CUZTDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(ZDSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CUZTDEST));
         }
      else
         {
         WinSetDlgItemText(hwndDlg, ID_CUZTDEST, CZDSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CUZTDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(CZDSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CUZTDEST));
         }
	
     WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_CUZTCANCEL :
            WinDismissDlg(hwndDlg, FALSE);
            break;

         case ID_CUZTOK :
            {
            WinQueryDlgItemText(hwndDlg, ID_CUZTDEST, sizeof(CZDSTR), CZDSTR);
            WinQueryDlgItemText(hwndDlg, ID_CUZTARGS, sizeof(CUNZIPARGS), CUNZIPARGS);
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;


         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}





MRESULT EXPENTRY cztProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


      switch( (INT)mp2 )
         {
         case 1:
            WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR),
                                        "Custom Settings : Zip this file (this session only)");
            break;

         case 2:
            WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR),
                                        "Custom Settings : Zip this folder (this session only)");
            break;

         case 3:
            WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR),
                                        "Custom Settings : Zip this tree (this session only)");
            break;

        default:
            break;
         }

      WinSendDlgItemMsg(hwndDlg, ID_CZTARGS,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(60,0),NULL);

      if( strlen(czipArgs) == 0 )
         WinSetDlgItemText(hwndDlg, ID_CZTARGS, zipArgs);
      else
         WinSetDlgItemText(hwndDlg, ID_CZTARGS, czipArgs);


      WinSendDlgItemMsg(hwndDlg, ID_CZTDEST,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(ZZMAXPATH,0),NULL);

      if( strlen(CDFSTR) == 0 )
         {
         WinSetDlgItemText(hwndDlg, ID_CZTDEST, DFSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CZTDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(DFSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CZTDEST));
         }
      else
         {
         WinSetDlgItemText(hwndDlg, ID_CZTDEST, CDFSTR);
         WinSendDlgItemMsg(hwndDlg , ID_CZTDEST, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(CDFSTR)), 0) ;
         WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CZTDEST));
         }
	
     WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_CZTCANCEL :
            WinDismissDlg(hwndDlg, FALSE);
            break;

         case ID_CZTOK :
            {
            WinQueryDlgItemText(hwndDlg, ID_CZTDEST, sizeof(CDFSTR), CDFSTR);
            WinQueryDlgItemText(hwndDlg, ID_CZTARGS, sizeof(czipArgs), czipArgs);
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;


         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}





BOOL setConMenu( HWND hmenu, USHORT msg)
{
MENUITEM mi ;
ULONG ulStyle ;

WinSendMsg( hmenu, MM_QUERYITEM, MPFROM2SHORT( msg, TRUE), MPFROMP( &mi)) ;

if( !mi.hwndSubMenu)
   return FALSE ;

ulStyle = WinQueryWindowULong( mi.hwndSubMenu, QWL_STYLE) ;
if( WinSetWindowULong( mi.hwndSubMenu, QWL_STYLE, ulStyle | MS_CONDITIONALCASCADE))
   return TRUE ;

return FALSE ;
}





HOBJECT makeShadow(CHAR *pathS, CHAR *fold)
{
CHAR pathST[ZZMAXPATH];
HOBJECT hobj;
CHAR title[ZZMAXPATH];
CHAR setupStr[ZZMAXPATH];
INT i, k;

strcpy(pathST, pathS);

if( pathST[strlen(pathST)-1] == '\\' )
   pathST[strlen(pathST)-1] = '\0';

for( i=0;i<strlen(pathST);i++ )
   {
   if( pathST[i] == '\\' )
      k = i;
   }

strncpy(title, pathST+(k+1), strlen(pathST)-(k+1));
title[strlen(pathST)-(k+1)] = '\0';
strcpy(setupStr, "SHADOWID=");
strcat(setupStr, pathST);

hobj = WinCreateObject("WPSHADOW",
                       title,
                       setupStr,
                       fold,
                       CO_FAILIFEXISTS);
return(hobj);
}




INT makeFolders(CHAR *pathStr)
{
INT i, k, numFolds;
INT mark[50];
CHAR tmpStr[ZZMAXPATH];
CHAR baseFold[ZZMAXPATH];
CHAR mainFold[ZZMAXPATH];
CHAR str[ZZMAXPATH];
CHAR DTOPNAME[ZZMAXPATH];

strncpy(DTOPNAME, DTOP+3, strlen(DTOP)-3);
DTOPNAME[strlen(DTOP)-3] = '\0';

numFolds = 0;
strcpy(tmpStr, pathStr);
if( tmpStr[strlen(tmpStr)-1] != '\\' )
   strcat(tmpStr, "\\");

for( i=0,k=0;i<strlen(tmpStr);i++ )
   {
   if( tmpStr[i] == '\\' )
      {
      numFolds++;
      mark[k] = i;
      k++;
      }
   }

for( i=0;i<(numFolds -1);i++ )
   {
   strncpy(baseFold, tmpStr, mark[i]);
   baseFold[mark[i]] = '\0';

   strncpy(mainFold, tmpStr+(mark[i]+1), (mark[i+1])-(mark[i]+1));
   mainFold[(mark[i+1])-(mark[i]+1)] = '\0';

   if( stricmp(mainFold, DTOPNAME) !=0 )
      WinCreateObject("WPFolder",
                      mainFold,
                      "CLOSED=DEFAULT",
                      baseFold,
                      CO_FAILIFEXISTS);
   }
return(1);
}






VOID zzSettingsPage(PVOID n)
{
HWND hwndF;
HAB        habAnchor ;
HMQ        hmqQueue ;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);

setINI();
queryZZSet();
saveZZSet();
hwndF = WinLoadDlg(HWND_DESKTOP,
                              HWND_DESKTOP,
                              ZipZapSettingsProc,
                              hResource,
                              ID_NEWZIPSET, 0);

WinProcessDlg(hwndF);
WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
hwndZT = NULLHANDLE;
return ;
}





VOID _Optlink createNewDlg(PVOID n)
{
HWND hwndF;
HAB        habAnchor ;
HMQ        hmqQueue ;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);

setINI();
hwndF = WinLoadDlg(HWND_DESKTOP,
                              HWND_DESKTOP,
                              createNewProc,
                              hResource,
                              ID_CREATENEW, 0);

WinProcessDlg(hwndF);
WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
hwndZT = NULLHANDLE;
return ;
}






MRESULT EXPENTRY createNewProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


      if( strlen(defZipFile) < 8 )
         {
         strcpy(defZipFile, " :\\Desktop\\zipzap.zip");
         defZipFile[0] = DTOP[0];
         }
      WinSendDlgItemMsg(hwndDlg, ID_CNENTRY,EM_SETTEXTLIMIT,
                                  MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_CNENTRY, defZipFile);
      WinSendDlgItemMsg(hwndDlg , ID_CNENTRY, EM_SETSEL ,
	     	             MPFROM2SHORT(0,strlen(defZipFile)), 0) ;
      WinSetFocus(HWND_DESKTOP, WinWindowFromID(hwndDlg, ID_CNENTRY));
	     	
     WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_CNCREATE :
            {
            CHAR NZZOB[ZZMAXPATH];
            CHAR fold[ZZMAXPATH];
            CHAR name[ZZMAXPATH];
            INT len, h, z;
            CHAR stext[] = "Create new .ZIP file ...";
            CHAR oktext[] = "ZipZap file successfully created!";


            WinQueryDlgItemText(hwndDlg, ID_CNENTRY, sizeof(NZZOB), NZZOB);
            WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCREATE), FALSE);
            WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCANCEL), FALSE);
            len = strlen(NZZOB);
            if( len < 8  )
               {
               msgBox(hwndDlg, "Attention!", "Fully qualified new file name must be entered and have the .ZIP extention.");
               WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCREATE), TRUE);
               WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCANCEL), TRUE);
               return(0);
               }

            if( strcmpi(NZZOB + (strlen(NZZOB) - 4), ".ZIP") != 0 || NZZOB[1] != ':'  || NZZOB[2] != '\\' )
               {
               msgBox(hwndDlg, "Attention!", "Fully qualified new file name must be entered and have the .ZIP extention.");
               WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCREATE), TRUE);
               WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCANCEL), TRUE);
               return(0);
               }

            strcpy(defZipFile, NZZOB);
            strcpy(fold, NZZOB);
            strcpy(name, NZZOB);
            for( h=0;h<len;h++ )
               {
               if( fold[h] == '\\' )
                  z = h;
               }
            strndel(name, z+1);
            if( z == 2 )
               fold[z+1] = '\0';
            else
               fold[z] = '\0';

            if( WinCreateObject("WPDataFile", name, "TEMPLATE=NO",
                                       fold, CO_FAILIFEXISTS) != NULLHANDLE )
               {
               DosBeep(3100, 100);
               WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), oktext);
               DosSleep(750);
               WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), stext);
               }
            else
               {
               DosBeep(100, 200);
               msgBox(hwndDlg, "Attention!", "ZipZap file creation FAILED! (Object may already exist)");
               }
            WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCREATE), TRUE);
            WinEnableWindow (WinWindowFromID (hwndDlg, ID_CNCANCEL), TRUE);
            }
            break;

         case ID_CNCANCEL :
            {
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;

         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}






VOID _Optlink aboutDlg(PVOID n)
{
HWND hwndF;
HAB        habAnchor ;
HMQ        hmqQueue ;
INT         mode;


habAnchor = WinInitialize (0) ;
hmqQueue = WinCreateMsgQueue (habAnchor, 0) ;
WinCancelShutdown(hmqQueue, TRUE);

mode = (INT)n;

if( mode == 1 )
   DosSleep(3000);

if( pgmData[48] || mode == 3 )
   {
   hwndF = WinLoadDlg(HWND_DESKTOP,
                                 HWND_DESKTOP,
                                 aboutProc,
                                 hResource,
                                 ID_ABOUTZIPZAP, 0);

   WinProcessDlg(hwndF);
   }

WinDestroyMsgQueue ( hmqQueue ) ;
WinTerminate ( habAnchor ) ;
hwndZT = NULLHANDLE;
return ;
}





MRESULT EXPENTRY aboutProc(HWND hwndDlg, ULONG msg,
                                         MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


     if( chkreg()  )
        WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), "About ZipZap ...");
     else
        WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), "THIS PROGRAM IS NOT REGISTERED!");
     WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}






MRESULT EXPENTRY additionalProc(HWND hwndDlg, ULONG msg,
                                                  MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      {
      INT x_screen, y_screen, x_offset, y_offset;
      POINTL pt;
      SWP swp;


      WinSendDlgItemMsg(hwndDlg, ID_ZZREGC,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_ZZREGC, sprc);

      WinSendDlgItemMsg(hwndDlg, ID_DEFEDITOREF,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_DEFEDITOREF, nzShowCEdit);

      WinSendDlgItemMsg(hwndDlg, ID_EXTZVIEWEF,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_EXTZVIEWEF, nzExtZipView);
      if( pgmData[26] == 1 )
         WinCheckButton(hwndDlg,ID_VBOUTPUT,1);
      else
         WinCheckButton(hwndDlg,ID_VBOUTPUT,0);

      if( pgmData[32] == 1 )
         WinCheckButton(hwndDlg,ID_ENABLEDCLICKVIEW,1);
      else
         WinCheckButton(hwndDlg,ID_ENABLEDCLICKVIEW,0);

      if( pgmData[48] == 1 )
         WinCheckButton(hwndDlg,ID_SHOWABOUTATBOOT,1);
      else
         WinCheckButton(hwndDlg,ID_SHOWABOUTATBOOT,0);

      if( !chkreg() )
         {
         pgmData[48] = 1;
         WinCheckButton(hwndDlg,ID_SHOWABOUTATBOOT,1);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWABOUTATBOOT), FALSE);
         }

      if( pgmData[47] == 0 )
         {
         WinCheckButton(hwndDlg,ID_VBDOUBLECLICK,1);
         WinCheckButton(hwndDlg,ID_VBMENUITEM,0);
         }
      else
         {
         WinCheckButton(hwndDlg,ID_VBDOUBLECLICK,0);
         WinCheckButton(hwndDlg,ID_VBMENUITEM,1);
         }

      if( pgmData[24] == 1 )
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_USEEXTVIEW), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBDOUBLECLICK), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBMENUITEM), TRUE);
         WinCheckButton(hwndDlg,ID_ENABLESHOWCONTENTS,1);
         }
      else
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_USEEXTVIEW), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBDOUBLECLICK), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBMENUITEM), FALSE);
         WinCheckButton(hwndDlg,ID_ENABLESHOWCONTENTS,0);
         }

      if( pgmData[25] == 1 )
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), FALSE);
         WinCheckButton(hwndDlg,ID_USEEXTVIEW,1);
         }
      else
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), FALSE);
         WinCheckButton(hwndDlg,ID_USEEXTVIEW,0);
         }


      WinQueryWindowPos( hwndDlg, &swp );
      WinQueryPointerPos( HWND_DESKTOP, &pt );
      swp.x = pt.x - (swp.cx /2);
      swp.y = pt.y - (swp.cy /2);
      x_screen = WinQuerySysValue( HWND_DESKTOP, SV_CXSCREEN );
      y_screen = WinQuerySysValue( HWND_DESKTOP, SV_CYSCREEN );
      x_offset = x_screen*.005;
      y_offset = y_screen*.005;
      if ( swp.cx + swp.x  > x_screen )
         swp.x = x_screen - (swp.cx + x_offset);
      if ( swp.x <= 0 )
         swp.x = x_offset;
      if ( swp.y + swp.cy > y_screen )
         swp.y = y_screen - (swp.cy + y_offset);
      if ( swp.y <= 0 )
         swp.y = y_offset;
      WinSetWindowPos(hwndDlg, HWND_TOP,
                                swp.x, swp.y, 0, 0,
		        SWP_ACTIVATE | SWP_MOVE | SWP_SHOW );
      }
      break;

   case WM_CONTROL:
      switch (SHORT1FROMMP(mp1))
         {
         case ID_ENABLESHOWCONTENTS:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( !WinQueryButtonCheckstate(hwndDlg, ID_ENABLESHOWCONTENTS) )
                  {
                  WinCheckButton(hwndDlg,ID_ENABLESHOWCONTENTS,TRUE);
                  if( !WinQueryButtonCheckstate(hwndDlg, ID_USEEXTVIEW) )
                     {
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), TRUE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), TRUE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), TRUE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), TRUE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), FALSE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), FALSE);
                     }
                  else
                     {
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), TRUE);
                     WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), TRUE);
                     }
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBDOUBLECLICK), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBMENUITEM), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_USEEXTVIEW), TRUE);
                  pgmData[24] = 1;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_ENABLESHOWCONTENTS,FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBDOUBLECLICK), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBMENUITEM), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_USEEXTVIEW), FALSE);
                  pgmData[24] = 0;
                  }
               }
            return(MRESULT)TRUE;

         case ID_USEEXTVIEW:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( !WinQueryButtonCheckstate(hwndDlg, ID_USEEXTVIEW) )
                  {
                  WinCheckButton(hwndDlg,ID_USEEXTVIEW,TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), TRUE);
                  pgmData[25] = 1;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_USEEXTVIEW,FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITORLABEL), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREFLABEL), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_DEFEDITOREF), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_VBOUTPUT), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEF), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_EXTZVIEWEFLABEL), FALSE);
                  pgmData[25] = 0;
                  }
               }
            return(MRESULT)TRUE;
         }
         break;

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_CREATETEMPLATE :
            {
            if( WinCreateObject("WPDataFile", "zipzap.zip", "TEMPLATE=YES",
                                       "<WP_TEMPS>", CO_FAILIFEXISTS) != NULLHANDLE )
               {
               DosBeep(3100, 100);
               msgBox(HWND_DESKTOP, "Attention!", "ZipZap template object successfully created!");
               }
            else
               {
               DosBeep(100, 200);
               msgBox(HWND_DESKTOP, "Attention!", "ZipZap template object creation FAILED! (Object may already exist)");
               }
            }
            break;

         case ID_VOK :
            {
            WinQueryDlgItemText(hwndDlg, ID_ZZREGC, sizeof(sprc), sprc);
            WinQueryDlgItemText(hwndDlg, ID_DEFEDITOREF, sizeof(nzShowCEdit), nzShowCEdit);
            WinQueryDlgItemText(hwndDlg, ID_EXTZVIEWEF, sizeof(nzExtZipView), nzExtZipView);

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEDCLICKVIEW) )
               pgmData[32] = 1;
            else
               pgmData[32] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLESHOWCONTENTS) )
               pgmData[24] = 1;
            else
               pgmData[24] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_USEEXTVIEW) )
               pgmData[25] = 1;
            else
               pgmData[25] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_VBOUTPUT) )
               pgmData[26] = 1;
            else
               pgmData[26] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_VBDOUBLECLICK) )
               pgmData[47] = 0;
            else
               pgmData[47] = 1;

            if( WinQueryButtonCheckstate(hwndDlg, ID_SHOWABOUTATBOOT) )
               pgmData[48] = 1;
            else
               pgmData[48] = 0;

            saveZZSet();
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;

         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return (MRESULT) FALSE;
}





MRESULT EXPENTRY ZipZapSettingsProc( HWND hwndDlg, ULONG msg,
                          MPARAM mp1, MPARAM mp2 )
{

switch ( msg )
   {
   case WM_INITDLG:
      {
      ULONG dtHeight, dtWidth, lHeight, lWidth;
      SWP swp;
      CHAR rtxt[] = "ZipZap main settings page";
      CHAR urtxt[] = "ZipZap main settings page (This program is NOT REGISTERED)";



      hinit.cb = sizeof( HELPINIT);
      hinit.ulReturnCode = 0L;
      hinit.pszTutorialName = NULL;
      hinit.phtHelpTable = (PHELPTABLE)MAKELONG(NULLHANDLE, 0xFFFF);
      hinit.hmodHelpTableModule = (HMODULE) NULL;
      hinit.hmodAccelActionBarModule = (HMODULE)NULL;
      hinit.idAccelTable = 0;
      hinit.idActionBar = 0;
      hinit.pszHelpWindowTitle = "ZipZap for OS/2";
      hinit.fShowPanelId = CMIC_HIDE_PANEL_ID;
      hinit.pszHelpLibraryName = "zipzap.hlp";

      if( (hwndHelp = WinCreateHelpInstance(WinQueryAnchorBlock(hwndDlg), &hinit)) != NULLHANDLE)
         {
         if(hinit.ulReturnCode)
            {
            WinDestroyHelpInstance( hwndHelp);
            }
         }


      if (hwndHelp)
         WinAssociateHelpInstance (hwndHelp, hwndDlg);


      dtHeight = WinQuerySysValue(HWND_DESKTOP,SV_CYSCREEN);
      dtWidth = WinQuerySysValue(HWND_DESKTOP,SV_CXSCREEN);
      WinQueryWindowPos(hwndDlg, (PSWP) &swp);
      lWidth = (dtWidth/2) - (swp.cx/2);
      lHeight = (dtHeight/2) - (swp.cy/2);
      WinSetWindowPos(hwndDlg, HWND_TOP, lWidth, lHeight, 0, 0, SWP_MOVE | SWP_SHOW | SWP_ACTIVATE);

      _wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                       DTOP, &dtopsize, TRUE);
      queryZZSet();
      if( chkreg() )
         {
         WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), rtxt);
         }
      else
         {
         WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), urtxt);
         }
      WinSendDlgItemMsg(hwndDlg, ID_DEFDEST,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_DEFDEST, ZDSTR);
      WinSendDlgItemMsg (hwndDlg ,ID_DEFDEST, EM_SETSEL ,
                         MPFROM2SHORT(0,sizeof(ZDSTR)), MPVOID  ) ;
      WinSendDlgItemMsg(hwndDlg, ID_ZIPICONFILE,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinSetDlgItemText(hwndDlg, ID_ZIPICONFILE, ZIPICON);
      WinSetDlgItemText(hwndDlg, ID_UNZIPARGS, UNZIPARGS);

      WinSendDlgItemMsg(hwndDlg, ID_ZIPARGS, EM_SETTEXTLIMIT,
                        MPFROM2SHORT(60,0),NULL);

      WinSetDlgItemText(hwndDlg, ID_ZIPARGS, zipArgs);

      WinSendDlgItemMsg(hwndDlg, ID_DEFFOLDDEST,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);

      WinSetDlgItemText(hwndDlg, ID_DEFFOLDDEST, DFSTR);

      WinSendDlgItemMsg (hwndDlg ,ID_DEFFOLDDEST, EM_SETSEL ,
                         MPFROM2SHORT(0,sizeof(DFSTR)), MPVOID  ) ;

      if( pgmData[43] == 1 )
         WinCheckButton(hwndDlg,ID_SHOWFOLDSESSION,1);
      else
         WinCheckButton(hwndDlg,ID_SHOWFOLDSESSION,0);

      if( pgmData[44] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOCLOSEFOLDSESSION,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOCLOSEFOLDSESSION,0);

      if( pgmData[45] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOOPENZIP,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOOPENZIP,0);

      if( pgmData[55] == 1 )
         WinCheckButton(hwndDlg,ID_ZIPDONEBEEP,1);
      else
         WinCheckButton(hwndDlg,ID_ZIPDONEBEEP,0);

      if( pgmData[56] == 1 )
         WinCheckButton(hwndDlg,ID_F12KEY,1);
      else
         WinCheckButton(hwndDlg,ID_F12KEY,0);

      if( pgmData[57] == 1 )
         WinCheckButton(hwndDlg,ID_F11KEY,1);
      else
         WinCheckButton(hwndDlg,ID_F11KEY,0);

      if( pgmData[46] == 1 )
         WinCheckButton(hwndDlg,ID_CREATEZDSHADOW,1);
      else
         WinCheckButton(hwndDlg,ID_CREATEZDSHADOW,0);

      if( pgmData[42] == 1 )
         WinCheckButton(hwndDlg,ID_ENABLEADDTOZIPF,1);
      else
         WinCheckButton(hwndDlg,ID_ENABLEADDTOZIPF,0);

      if( pgmData[41] == 1 || pgmData[53] == 1 )
         {
         if( pgmData[41] == 1 )
            WinCheckButton(hwndDlg,ID_ENABLEZIPFOL,1);
         else
            WinCheckButton(hwndDlg,ID_ENABLEZIPFOL,0);
         if( pgmData[53] == 1 )
            WinCheckButton(hwndDlg,ID_ENABLEZIPTRE,1);
         else
            WinCheckButton(hwndDlg,ID_ENABLEZIPTRE,0);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), TRUE);
         }
      else
         {
         WinCheckButton(hwndDlg,ID_ENABLEZIPFOL,0);
         WinCheckButton(hwndDlg,ID_ENABLEZIPTRE,0);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), FALSE);
         }

      if( pgmData[0] == 1 )
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILE), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILELABEL), TRUE);
         WinCheckButton(hwndDlg,ID_REPLACEICON,1);
         }
      else
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILE), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILELABEL), FALSE);
         WinCheckButton(hwndDlg,ID_REPLACEICON,0);
         }

      if( pgmData[3] == 1 )
         WinCheckButton(hwndDlg,ID_SHOWZIPSESSION,1);
      else
         WinCheckButton(hwndDlg,ID_SHOWZIPSESSION,0);

      if( pgmData[4] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOCLOSESESSION,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOCLOSESESSION,0);

      if( pgmData[30] == 1 )
         WinCheckButton(hwndDlg,ID_UNZIPDONEBEEP,1);
      else
         WinCheckButton(hwndDlg,ID_UNZIPDONEBEEP,0);

      if( pgmData[5] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOOPENUNZIP,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOOPENUNZIP,0);

      if( pgmData[6] == 1 )
         WinCheckButton(hwndDlg,ID_CREATESHADOW,1);
      else
         WinCheckButton(hwndDlg,ID_CREATESHADOW,0);

      if( pgmData[7] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOOPENUNZIPPARENT,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOOPENUNZIPPARENT,0);

      if( pgmData[8] == 1 )
         WinCheckButton(hwndDlg,ID_CREATEDDSHADOW,1);
      else
         WinCheckButton(hwndDlg,ID_CREATEDDSHADOW,0);

      if( pgmData[10] == 1 )
         WinCheckButton(hwndDlg,ID_SHOWDDSESSION,1);
      else
         WinCheckButton(hwndDlg,ID_SHOWDDSESSION,0);

      if( pgmData[11] == 1 )
         WinCheckButton(hwndDlg,ID_AUTOCLOSEDDSESSION,1);
      else
         WinCheckButton(hwndDlg,ID_AUTOCLOSEDDSESSION,0);

      if( pgmData[33] == 1 )
         WinCheckButton(hwndDlg,ID_BEEPONCOMPLETIONDD,1);
      else
         WinCheckButton(hwndDlg,ID_BEEPONCOMPLETIONDD,0);

      if( pgmData[9] == 1 )
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWDDSESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEDDSESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_BEEPONCOMPLETIONDD), TRUE);
         WinCheckButton(hwndDlg,ID_ENABLEDRAGDROP,1);
         }
      else
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWDDSESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEDDSESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_BEEPONCOMPLETIONDD), FALSE);
         WinCheckButton(hwndDlg,ID_ENABLEDRAGDROP,0);
         }

      if( pgmData[22] == 1 )
         WinCheckButton(hwndDlg,ID_ENABLEZIPTHIS,1);
      else
         WinCheckButton(hwndDlg,ID_ENABLEZIPTHIS,0);

      if( pgmData[23] == 1 )
         WinCheckButton(hwndDlg,ID_ENABLEADDTOZIP,1);
      else
         WinCheckButton(hwndDlg,ID_ENABLEADDTOZIP,0);

      if( pgmData[1] == 1 )
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATESHADOW), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEDDSHADOW), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIP), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIPPARENT), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWZIPSESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSESESSION), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPDONEBEEP), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGS), TRUE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGSLABEL), TRUE);
         WinCheckButton(hwndDlg,ID_ENABLEUNZIPM,1);
         }
      else
         {
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATESHADOW), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEDDSHADOW), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIP), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIPPARENT), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWZIPSESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSESESSION), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPDONEBEEP), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGS), FALSE);
         WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGSLABEL), FALSE);
         WinCheckButton(hwndDlg,ID_ENABLEUNZIPM,0);
         }

      }
      break;


   case WM_DESTROY:
      if (hwndHelp)
         {
         WinAssociateHelpInstance (NULLHANDLE, hwndDlg);
         WinDestroyHelpInstance( hwndHelp);
         }
      break;

   case WM_CONTROL:
      switch (SHORT1FROMMP(mp1))
         {
         case ID_ENABLEZIPFOL:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPFOL) )
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEZIPFOL,FALSE);
                  pgmData[41] = 0;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEZIPFOL,TRUE);
                  pgmData[41] = 1;
                  }
               if( !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPFOL) &&
                   !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPTRE) )
                  {
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), FALSE);
                  }
               else
                  {
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), TRUE);
                  }
               }
            return(MRESULT)TRUE;

         case ID_ENABLEZIPTRE:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPTRE) )
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEZIPTRE,FALSE);
                  pgmData[41] = 0;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEZIPTRE,TRUE);
                  pgmData[41] = 1;
                  }
               if( !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPFOL) &&
                   !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPTRE) )
                  {
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), FALSE);
                  }
               else
                  {
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWFOLDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEFOLDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENZIP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEZDSHADOW), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPDONEBEEP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGS), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPARGSLABEL), TRUE);
                  }
               }
            return(MRESULT)TRUE;

         case ID_ENABLEUNZIPM:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEUNZIPM) )
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEUNZIPM,TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATESHADOW), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEDDSHADOW), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIPPARENT), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWZIPSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSESESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPDONEBEEP), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGS), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGSLABEL), TRUE);
                  pgmData[1] = 1;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEUNZIPM,FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATESHADOW), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_CREATEDDSHADOW), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOOPENUNZIPPARENT), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWZIPSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSESESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPDONEBEEP), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGS), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_UNZIPARGSLABEL), FALSE);
                  pgmData[1] = 0;
                  }
               }
            return(MRESULT)TRUE;

         case ID_REPLACEICON:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( !WinQueryButtonCheckstate(hwndDlg, ID_REPLACEICON) )
                  {
                  WinCheckButton(hwndDlg,ID_REPLACEICON,TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILE), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILELABEL), TRUE);
                  pgmData[0] = 1;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_REPLACEICON,FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILE), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_ZIPICONFILELABEL), FALSE);
                  pgmData[0] = 0;
                  }
               }
            return(MRESULT)TRUE;

         case ID_ENABLEDRAGDROP:
            if (HIUSHORT(mp1) == BN_CLICKED)
               {
               if( !WinQueryButtonCheckstate(hwndDlg, ID_ENABLEDRAGDROP) )
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEDRAGDROP,TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWDDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEDDSESSION), TRUE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_BEEPONCOMPLETIONDD), TRUE);
                  pgmData[9] = 1;
                  }
               else
                  {
                  WinCheckButton(hwndDlg,ID_ENABLEDRAGDROP,FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_SHOWDDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_AUTOCLOSEDDSESSION), FALSE);
                  WinEnableWindow(WinWindowFromID(hwndDlg, ID_BEEPONCOMPLETIONDD), FALSE);
                  pgmData[9] = 0;
                  }
               }
            return(MRESULT)TRUE;
         }
         break;


   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case ID_ZIPZAPHELPBUTTON :
            {
            if( hwndHelp )
	     {
	     WinSendMsg(hwndHelp, HM_HELP_CONTENTS,
	                     (MPARAM)0, (MPARAM)0);
	     }
	  }
            break;

         case ID_ADDITIONALSETBUTTON :
            {
            HWND hwndF;
            CHAR rtxt[] = "ZipZap main settings page";
            CHAR urtxt[] = "ZipZap main settings page (This program is NOT REGISTERED)";


            hwndF = WinLoadDlg(HWND_DESKTOP,
                                          hwndDlg,
                                          additionalProc,
                                          hResource,
                                          ID_ADDITIONALSETDLG, 0);

            WinProcessDlg(hwndF);
            if( chkreg() )
               {
               WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), rtxt);
               }
            else
               {
               WinSetWindowText(WinWindowFromID(hwndDlg, FID_TITLEBAR), urtxt);
               }
            }
            break;

         case ID_ZIPZAPSETOK :
            WinQueryDlgItemText(hwndDlg, ID_DEFDEST, sizeof(ZDSTR), ZDSTR);
            WinQueryDlgItemText(hwndDlg, ID_ZIPICONFILE, sizeof(ZIPICON), ZIPICON);
            WinQueryDlgItemText(hwndDlg, ID_UNZIPARGS, sizeof(UNZIPARGS), UNZIPARGS);


            WinQueryDlgItemText(hwndDlg, ID_ZIPARGS, sizeof(zipArgs), zipArgs);
            WinQueryDlgItemText(hwndDlg, ID_DEFFOLDDEST, sizeof(DFSTR), DFSTR);

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPFOL) )
               pgmData[41] = 1;
            else
               pgmData[41] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPTRE) )
               pgmData[53] = 1;
            else
               pgmData[53] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_SHOWFOLDSESSION) )
               pgmData[43] = 1;
            else
               pgmData[43] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOCLOSEFOLDSESSION) )
               pgmData[44] = 1;
            else
               pgmData[44] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOOPENZIP) )
               pgmData[45] = 1;
            else
               pgmData[45] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ZIPDONEBEEP) )
               pgmData[55] = 1;
            else
               pgmData[55] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_F12KEY) )
               pgmData[56] = 1;
            else
               pgmData[56] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_F11KEY) )
               pgmData[57] = 1;
            else
               pgmData[57] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_CREATEZDSHADOW) )
               pgmData[46] = 1;
            else
               pgmData[46] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEADDTOZIPF) )
               pgmData[42] = 1;
            else
               pgmData[42] = 0;


            if( WinQueryButtonCheckstate(hwndDlg, ID_REPLACEICON) )
               pgmData[0] = 1;
            else
               pgmData[0] = 0;


            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEUNZIPM) )
               pgmData[1] = 1;
            else
               pgmData[1] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_SHOWZIPSESSION) )
               pgmData[3] = 1;
            else
               pgmData[3] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOCLOSESESSION) )
               pgmData[4] = 1;
            else
               pgmData[4] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_UNZIPDONEBEEP) )
               pgmData[30] = 1;
            else
               pgmData[30] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOOPENUNZIP) )
               pgmData[5] = 1;
            else
               pgmData[5] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_CREATESHADOW) )
               pgmData[6] = 1;
            else
               pgmData[6] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOOPENUNZIPPARENT) )
               pgmData[7] = 1;
            else
               pgmData[7] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_CREATEDDSHADOW) )
               pgmData[8] = 1;
            else
               pgmData[8] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEDRAGDROP) )
               pgmData[9] = 1;
            else
               pgmData[9] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_SHOWDDSESSION) )
               pgmData[10] = 1;
            else
               pgmData[10] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_AUTOCLOSEDDSESSION) )
               pgmData[11] = 1;
            else
               pgmData[11] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEZIPTHIS) )
               pgmData[22] = 1;
            else
               pgmData[22] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_ENABLEADDTOZIP) )
               pgmData[23] = 1;
            else
               pgmData[23] = 0;

            if( WinQueryButtonCheckstate(hwndDlg, ID_BEEPONCOMPLETIONDD) )
               pgmData[33] = 1;
            else
               pgmData[33] = 0;

            saveZZSet();
            WinDismissDlg(hwndDlg, TRUE);
            break;

         default :
            return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
         }
      break;

   default :
      return WinDefDlgProc( hwndDlg, msg, mp1, mp2 );
   }
return(FALSE);
}






VOID saveZZSet(VOID)
{
HINI MYHINI;

if ( (MYHINI = PrfOpenProfile(0, ZZINI )) != NULLHANDLE )
   {
   PrfWriteProfileData(MYHINI,
                    "ZIPZAP",
                    "ZIPZAPSET",
                    &pgmData,
                    sizeof(pgmData));

   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NFDESTSTR", DFSTR);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NZDESTSTR", ZDSTR);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NZSHOWEDIT", nzShowCEdit);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NZEXTVIEW", nzExtZipView);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "ZIPICONFILE", ZIPICON);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "LOADDSKFARGS", loaddskfARGS);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "XDFCOPYARGS", xdfcopyARGS);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "UNPACKARGS", unpackARGS);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "ARGSUPP", argsUPP);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "DEFDESTUPP", defdestUPP);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "DEFDESTUP", defdestUP);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "DEFEDITORUPS", defeditorUPS);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "UNZIPARGS", UNZIPARGS);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "ZIPARGS", zipArgs);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NZSHOWEDIT", nzShowCEdit);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                      "NZEXTVIEW", nzExtZipView);
   PrfWriteProfileString(MYHINI, "ZIPZAP",
                              "ZIPZAPSPRC", sprc);
   }
}






VOID queryZZSet(VOID)
{
ULONG rsizeX;
HINI MYHINI;


if( DosQueryModuleName(hResource, sizeof(ZZINI), ZZINI) == 0 )
   {
   INT cc, gg;

   for( cc=0;cc<strlen(ZZINI);cc++ )
       {
       if( ZZINI[cc] == '\\' )
          gg = cc;
       }

   ZZINI[gg+1] = '\0';
   strcat(ZZINI, ZZINIFN);
   }

_wpQueryRealName(_wpclsQueryActiveDesktop(_WPDesktop),
                           DTOP, &dtopsize, TRUE);
strcpy(DFAULTDESTF, DTOP);
if( DTOP[strlen(DTOP)-1] != '\\' )
   strcat(DFAULTDESTF, "\\");
strcat(DFAULTDESTF, "ZZUZIPS");

strcpy(DFAULTDESTZ, DTOP);
if( DTOP[strlen(DTOP)-1] != '\\' )
   strcat(DFAULTDESTZ, "\\");
strcat(DFAULTDESTZ, "ZZZIPS");


if ( (MYHINI = PrfOpenProfile(0, ZZINI )) != NULLHANDLE )
   {
   PrfQueryProfileSize(MYHINI,
                    "ZIPZAP",
                    "ZIPZAPSET", &rsizeX);
   if ( rsizeX == (sizeof(pgmData)) )
      {
      PrfQueryProfileData(MYHINI,
                       "ZIPZAP",
                       "ZIPZAPSET",
                        &pgmData, &rsizeX);
      }
   else
      {
      pgmData[0] = 0;
      pgmData[1] = 1;
      pgmData[2] = 1;
      pgmData[3] = 1;
      pgmData[4] = 1;
      pgmData[5] = 0;
      pgmData[6] = 0;
      pgmData[7] = 1;
      pgmData[8] = 1;
      pgmData[9] = 1;
      pgmData[10] = 1;
      pgmData[11] = 1;
      pgmData[12] = 1;
      pgmData[13] = 0;
      pgmData[14] = 0;
      pgmData[15] = 0;
      pgmData[16] = 0;
      pgmData[17] = 0;
      pgmData[18] = 0;
      pgmData[19] = 0;
      pgmData[20] = 0;
      pgmData[21] = 0;
      pgmData[22] = 1;
      pgmData[23] = 1;
      pgmData[24] = 1;
      pgmData[25] = 0;
      pgmData[26] = 0;
      pgmData[27] = 1;
      pgmData[28] = 2;
      pgmData[29] = 1;
      pgmData[30] = 1;
      pgmData[31] = 0;
      pgmData[32] = 0;
      pgmData[33] = 1;
      pgmData[34] = 0;  /* Auxilliary funcs enable */
      pgmData[35] = 0;  /* Autoclose Make Disk From Image session */
      pgmData[36] = 0;  /* Beep on completion of Make Disk From Image session */
      pgmData[37] = 1;  /* show unpack auto session*/
      pgmData[38] = 1;  /* autoclose unpack auto session*/
      pgmData[39] = 0;  /* Beep on completion unpack auto session*/
      pgmData[40] = 1;  /* Create shadow dest folder unpack auto session*/
      pgmData[41] = 1;
      pgmData[42] = 1;
      pgmData[43] = 1;
      pgmData[44] = 1;
      pgmData[45] = 1;
      pgmData[46] = 0;
      pgmData[47] = 1;   /*  view by double-clicking ZIP = 0  menu = 1 */
      pgmData[48] = 1;   /*  Show about scren at boot up */
      pgmData[49] = 0;
      pgmData[50] = 0;
      pgmData[51] = 0;
      pgmData[52] = 0;
      pgmData[53] = 1;
      pgmData[54] = 0;
      pgmData[55] = 1;
      pgmData[56] = 0;  // F12 HotKey
      pgmData[57] = 0;  // F11 HotKey
      }

   PrfQueryProfileString(MYHINI, "ZIPZAP", "NFDESTSTR",
                      DFAULTDESTZ, DFSTR, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZDESTSTR",
                      DFAULTDESTF, ZDSTR, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZSHOWEDIT",
                      "E.EXE", nzShowCEdit, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZEXTVIEW",
                      "", nzExtZipView, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPICONFILE",
                      "", ZIPICON, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "LOADDSKFARGS",
                      "/Y /S /Q", loaddskfARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "XDFCOPYARGS",
                      "/Y /NV", xdfcopyARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "UNPACKARGS",
                      "", unpackARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ARGSUPP",
                      "", argsUPP, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFDESTUPP",
                      "", defdestUPP, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFDESTUP",
                      DFAULTDESTF, defdestUP, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFEDITORUPS",
                      "E.EXE", defeditorUPS, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "UNZIPARGS",
                      "", UNZIPARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPARGS",
                      "", zipArgs, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZSHOWEDIT",
                      "E.EXE", nzShowCEdit, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZEXTVIEW",
                      "", nzExtZipView, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPZAPSPRC",
                      "", sprc, ZZMAXPATH );
   }
else
   {
   pgmData[0] = 0;
   pgmData[1] = 1;
   pgmData[2] = 1;
   pgmData[3] = 1;
   pgmData[4] = 1;
   pgmData[5] = 0;
   pgmData[6] = 0;
   pgmData[7] = 1;
   pgmData[8] = 1;
   pgmData[9] = 1;
   pgmData[10] = 1;
   pgmData[11] = 1;
   pgmData[12] = 1;
   pgmData[13] = 0;
   pgmData[14] = 0;
   pgmData[15] = 0;
   pgmData[16] = 0;
   pgmData[17] = 0;
   pgmData[18] = 0;
   pgmData[19] = 0;
   pgmData[20] = 0;
   pgmData[21] = 0;
   pgmData[22] = 1;
   pgmData[23] = 1;
   pgmData[24] = 1;
   pgmData[25] = 0;
   pgmData[26] = 0;
   pgmData[27] = 1;
   pgmData[28] = 2;
   pgmData[29] = 1;
   pgmData[30] = 1;
   pgmData[31] = 0;
   pgmData[32] = 0;
   pgmData[33] = 1;
   pgmData[34] = 0;  /* Auxilliary funcs enable */
   pgmData[35] = 0;  /* Autoclose Make Disk From Image session */
   pgmData[36] = 0;  /* Beep on completion of Make Disk From Image session */
   pgmData[37] = 1;  /* show unpack auto session*/
   pgmData[38] = 1;  /* autoclose unpack auto session*/
   pgmData[39] = 0;  /* Beep on completion unpack auto session*/
   pgmData[40] = 1;  /* Create shadow dest folder unpack auto session*/
   pgmData[41] = 1;
   pgmData[42] = 1;
   pgmData[43] = 1;
   pgmData[44] = 1;
   pgmData[45] = 1;
   pgmData[46] = 0;
   pgmData[47] = 1;   /*  view by double-clicking ZIP = 0  menu = 1 */
   pgmData[48] = 1;   /*  Show about scren at boot up */
   pgmData[49] = 0;
   pgmData[50] = 0;
   pgmData[51] = 0;
   pgmData[52] = 0;
   pgmData[53] = 1;
   pgmData[54] = 0;
   pgmData[55] = 1;
   pgmData[56] = 0;  // F12 HotKey
   pgmData[57] = 0;  // F11 HotKey

   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZDESTSTR",
                      DFAULTDESTF, ZDSTR, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZSHOWEDIT",
                      "E.EXE", nzShowCEdit, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZEXTVIEW",
                      "", nzExtZipView, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPICONFILE",
                      "", ZIPICON, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "LOADDSKFARGS",
                      "/Y /S /Q", loaddskfARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "XDFCOPYARGS",
                      "/Y /NV", xdfcopyARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "UNPACKARGS",
                      "", unpackARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ARGSUPP",
                      "", argsUPP, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFDESTUPP",
                      "", defdestUPP, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFDESTUP",
                      DFAULTDESTF, defdestUP, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "DEFEDITORUPS",
                      "E.EXE", defeditorUPS, ZZMAXPATH);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "UNZIPARGS",
                      "", UNZIPARGS, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPARGS",
                      "", zipArgs, 60);
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZSHOWEDIT",
                      "E.EXE", nzShowCEdit, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "NZEXTVIEW",
                      "", nzExtZipView, ZZMAXPATH );
   PrfQueryProfileString(MYHINI, "ZIPZAP", "ZIPZAPSPRC",
                      "", sprc, ZZMAXPATH );
   }
}




INT chkValidDPStr(CHAR *dstr)
{
CHAR dest[ZZMAXPATH];

if( strlen(dstr) < 2 || dstr[1] != ':' )
   return(0);
if( strlen(dstr) == 2 )
   {
   strcpy(dest, dstr);
   strcat(dest, "\\");
   }
else
   {
   strncpy(dest, dstr, 3);
   dest[3] = '\0';
   }
if( WinQueryObject(dest) == NULLHANDLE )
   return(0);
else
   return(1);
}




BOOL FindFile (HWND hwndWnd, CHAR *fullFileName)
{
HWND tempDlg;
CHAR fMask[10];
FILEDLG fdFileDlg;

strcpy(fullFileName, "");

memset ( &fdFileDlg, 0, sizeof ( FILEDLG )) ;
fdFileDlg.cbSize = sizeof ( FILEDLG ) ;
fdFileDlg.fl = FDS_CUSTOM | FDS_OPEN_DIALOG | FDS_CENTER;
fdFileDlg.pfnDlgProc = (PFNWP)findProc;
fdFileDlg.pszOKButton = NULL;
fdFileDlg.usDlgId = ID_FINDZIP;
fdFileDlg.hMod = hResource;
fdFileDlg.x = 0;
fdFileDlg.y = 0;

strcpy(fMask, "*.ZIP");
strcpy(fdFileDlg.szFullFile, fMask);

tempDlg = WinFileDlg( HWND_DESKTOP, hwndWnd, (PFILEDLG)&fdFileDlg );

if ( !tempDlg || (fdFileDlg.lReturn != DID_OK) )
   return FALSE;

strcpy(fullFileName, fdFileDlg.szFullFile);
if( strlen(fullFileName) > 0 )
   return TRUE ;
else
   return FALSE;
}




MRESULT EXPENTRY findProc( HWND hwndDlg, ULONG msg,
                           MPARAM mp1, MPARAM mp2 )
{
switch ( msg )
   {
   case WM_INITDLG:
      WinSendDlgItemMsg(hwndDlg, DID_FILENAME_ED,EM_SETTEXTLIMIT,
                        MPFROM2SHORT(ZZMAXPATH,0),NULL);
      WinDefFileDlgProc( hwndDlg, msg, mp1, mp2 );

   case WM_COMMAND :
      switch( SHORT1FROMMP( mp1 ) )
         {
         case DID_CANCEL :
            WinDismissDlg(hwndDlg, FALSE);
            break;

         case DID_OK :
            {
            INT sel;


            sel = (LONG)WinSendDlgItemMsg(hwndDlg, 266,
                                                          LM_QUERYSELECTION,
                                                          MPFROMLONG(LIT_FIRST),
                                                          MPFROMLONG(0));
            if(sel < 0)
               {
               msgBox(hwndDlg, "Attention!", "You did not select a file to add to.");
               return(0);
               }
            WinDismissDlg(hwndDlg, TRUE);
            }
            break;
         }
      break;
   }
return WinDefFileDlgProc( hwndDlg, msg, mp1, mp2 );
}





INT setCMDFileName(CHAR *fqfname, CHAR *fname)
{
CHAR suff[] = "  .cmd";
INT i;
CHAR num[4];
CHAR qnum[4];
CHAR rnum[4];

i = 0;

do
   {
   strcpy(fqfname, " :\\os2\\zip_n");
   strcpy(fname, "zip_n");
   fqfname[0] = DTOP[0];
   if( i < 10 )
      {
      itoa(i, num, 10);
      suff[0] = '0';
      suff[1] = num[0];
      }
   else
      {
      div_t res;

      res = div(i, 10);
      itoa(res.quot, qnum, 10);
      suff[0] = qnum[0];
      itoa(res.rem, rnum, 10);
      suff[1] = rnum[0];
      }
   i++;
   strcat(fqfname, suff);
   strcat(fname, suff);
   }
while( (existFile(fqfname) > 0) && (i < 98) );

return(i-1);
}






LONG existFile(CHAR *fileStr)
{
FILEFINDBUF3 findbuf;
HDIR hDir = HDIR_CREATE;
ULONG usSearchCount = 1;
ULONG ALLFILES;


ALLFILES = FILE_NORMAL | FILE_ARCHIVED | FILE_SYSTEM | FILE_READONLY | FILE_HIDDEN;
if(DosFindFirst(fileStr, &hDir, ALLFILES, (PVOID)&findbuf, sizeof(findbuf), &usSearchCount, FIL_STANDARD))
   {
   DosFindClose(hDir);
   return(0);
   }
else
   {
   DosFindClose(hDir);
   return(findbuf.cbFile);
   }
}






INT addDroppedFILES(CHAR *cmdParms, CHAR *zipFile, CHAR *droppedFiles, BOOL truncate)
{
PROGDETAILS  pDetails;
ULONG dSize;
CHAR dTopPath[ZZMAXPATH];
ULONG flgs;
CHAR pgmInputs[2000];
CHAR drv[3] = " :";
CHAR origdrv[3] = " :";
HFILE fhan;
APIRET rc;
ULONG act;
ULONG bwrote;
CHAR newline[] = "\n";
CHAR eoff[] = "@ECHO OFF";
CHAR cdtop[] = "cd\\";
CHAR cdup[] = "cd ..";
CHAR cdto[] = "cd";
CHAR space1[] = " ";
CHAR space2[] = "  ";
CHAR noEA[] = "-X";
CHAR zipr[] = "zip -r";
CHAR zipj[] = "zip -j";
CHAR ziptrunc[] = "zip -qF";
CHAR zipadd[] = "zip";
CHAR zipdelete[] = "zip -q -d";
CHAR tmpDir[] = " :\\OS2";
CHAR fqtmpFile[] = " :\\OS2\\NFNFTMP.DOC";
CHAR tmpFile[] = "NFNFTMP.DOC";
CHAR tmpCMD[40];
CHAR tmpCMDName[40];
CHAR allFiles[] = "\\*";
CHAR quote[] = "\"";
CHAR done[] = "EXIT";
CHAR foldName[ZZMAXPATH];
INT kz, iz;
CHAR tpath[ZZMAXPATH];
CHAR droppedFilesZ[ZZMAXPATH];
CHAR origPath[ZZMAXPATH];
CHAR obc[] = "drpObjectClass";
HAB  habAnchor;


strcpy(dTopPath, DTOP);
strcat(dTopPath, "\\");

setINI();
queryZZSet();
saveZZSet();

setfnum = setCMDFileName(tmpCMD, tmpCMDName);

strcpy(pgmInputs, "/C cls");
strcat(pgmInputs, "&");
strcat(pgmInputs, tmpCMDName);

/*  compose and write the file */
origdrv[0] = DTOP[0];
tmpDir[0] = DTOP[0];
fqtmpFile[0] = DTOP[0];

_getcwd(origPath, sizeof(origPath));

DosOpen(fqtmpFile, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
DosWrite(fhan, eoff, strlen(eoff), &bwrote);
DosClose(fhan);

DosOpen(tmpCMD, &fhan, &act, 0L, 0, 0x0012, OPEN_ACCESS_READWRITE | OPEN_SHARE_DENYNONE, 0L);
DosWrite(fhan, eoff, strlen(eoff), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);

if( truncate )
   {
   DosWrite(fhan, origdrv, strlen(drv), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   DosWrite(fhan, cdto, strlen(cdto), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, tmpDir, strlen(tmpDir), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   DosWrite(fhan, ziptrunc, strlen(ziptrunc), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, zipFile, strlen(zipFile), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, tmpFile, strlen(tmpFile), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);

   DosWrite(fhan, zipdelete, strlen(zipdelete), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, zipFile, strlen(zipFile), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);

   DosWrite(fhan, tmpFile, strlen(tmpFile), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   DosWrite(fhan, cdtop, strlen(cdtop), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   }

drv[0] = droppedFiles[0];

DosWrite(fhan, drv, strlen(drv), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);
DosWrite(fhan, cdto, strlen(cdto), &bwrote);
DosWrite(fhan, space1, strlen(space1), &bwrote);

strcpy(droppedFilesZ, droppedFiles);

if( droppedFilesZ[strlen(droppedFilesZ)-1] != '\\' )
   {
   if( strcmp(cmdParms, " -r ") == 0 )
      strcat(droppedFilesZ, "\\");
   }
else
   {
   if( strcmp(cmdParms, " -j ") == 0 )
      droppedFilesZ[strlen(droppedFilesZ)-1] = '\0';
   }

for( iz=0,kz=0;iz<strlen(droppedFilesZ);iz++ )
   {
   if( droppedFilesZ[iz] == '\\' )
      kz = iz;
   }

if( kz == 2 )
   {
   strncpy(tpath, droppedFilesZ, kz+1);
   tpath[kz+1] = '\0';
   }
else
   {
   strncpy(tpath, droppedFilesZ, kz);
   tpath[kz] = '\0';
   }

DosWrite(fhan, quote, strlen(quote), &bwrote);
DosWrite(fhan, tpath, strlen(tpath), &bwrote);
DosWrite(fhan, quote, strlen(quote), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);

if( strcmp(cmdParms, " -r ") == 0 )
   {
   DosWrite(fhan, cdup, strlen(cdup), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   }

for( iz=0,kz=0;iz<strlen(droppedFiles);iz++ )
   {
   if( droppedFiles[iz] == '\\' )
      kz = iz;
   }

strncpy(foldName, droppedFiles+(kz+1), strlen(droppedFiles)-(kz+1));
foldName[strlen(droppedFiles)-(kz+1)] = '\0';

if( strcmp(cmdParms, " -j ") == 0 )
   {
   DosWrite(fhan, zipj, strlen(zipr), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   if( strlen(noeas) > 0 )
      {
      DosWrite(fhan, noEA, strlen(noEA), &bwrote);
      DosWrite(fhan, space1, strlen(space1), &bwrote);
      }
   if( strlen(zipArgs) > 0 )
      {
      DosWrite(fhan, zipArgs, strlen(zipArgs), &bwrote);
      DosWrite(fhan, space1, strlen(space1), &bwrote);
      }
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, zipFile, strlen(zipFile), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, foldName, strlen(foldName), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   }
else
   {
   DosWrite(fhan, zipr, strlen(zipr), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   if( strlen(noeas) > 0 )
      {
      DosWrite(fhan, noEA, strlen(noEA), &bwrote);
      DosWrite(fhan, space1, strlen(space1), &bwrote);
      }
   if( strlen(zipArgs) > 0 )
      {
      DosWrite(fhan, zipArgs, strlen(zipArgs), &bwrote);
      DosWrite(fhan, space1, strlen(space1), &bwrote);
      }
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, zipFile, strlen(zipFile), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, space1, strlen(space1), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, foldName, strlen(foldName), &bwrote);
   DosWrite(fhan, allFiles, strlen(allFiles), &bwrote);
   DosWrite(fhan, quote, strlen(quote), &bwrote);
   DosWrite(fhan, newline, strlen(newline), &bwrote);
   }

DosWrite(fhan, cdtop, strlen(cdtop), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);
DosWrite(fhan, origdrv, strlen(origdrv), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);
DosWrite(fhan, cdtop, strlen(cdtop), &bwrote);
DosWrite(fhan, newline, strlen(newline), &bwrote);

DosWrite(fhan, cdto, strlen(cdto), &bwrote);
DosWrite(fhan, space1, strlen(space1), &bwrote);
DosWrite(fhan, quote, strlen(quote), &bwrote);
DosWrite(fhan, origPath, strlen(origPath), &bwrote);
DosWrite(fhan, quote, strlen(quote), &bwrote);

DosClose(fhan);

WinRegisterClass (habAnchor, obc, drpProc, 0, 0);

hwndDRP = WinCreateWindow(HWND_OBJECT,
                                           obc,
                                           NULL,
                                           0,
                                           0,
                                           0,
                                           0,
                                           0,
                                           HWND_OBJECT,
                                           HWND_BOTTOM,
                                           0L,
                                           (PVOID)NULL,
                                           (PVOID)NULL);

if( pgmData[10] && !pgmData[11] )
   flgs = SWP_ACTIVATE | SWP_SHOW | SWP_NOAUTOCLOSE;
if( !pgmData[10] && pgmData[11] )
   flgs = SWP_HIDE;
if( pgmData[10] && pgmData[11] )
   flgs = SWP_ACTIVATE | SWP_SHOW;
if( !pgmData[10] && !pgmData[11] )
   flgs = SWP_HIDE | SWP_NOAUTOCLOSE;

pDetails.Length          = sizeof(PROGDETAILS);
pDetails.progt.progc     = PROG_DEFAULT;
pDetails.progt.fbVisible = SHE_VISIBLE;
pDetails.pszTitle        = "ZipZap ADD TO ZIP!";
pDetails.pszExecutable   = "cmd.exe";
pDetails.pszParameters   = pgmInputs;
pDetails.pszStartupDir   = "";
pDetails.pszIcon         = "";
pDetails.pszEnvironment  = "";
pDetails.swpInitial.fl   = flgs;
pDetails.swpInitial.cy   = 0;
pDetails.swpInitial.cx   = 0;
pDetails.swpInitial.y    = 0;
pDetails.swpInitial.x    = 0;
pDetails.swpInitial.hwndInsertBehind = HWND_TOP;
pDetails.swpInitial.hwnd             = hwndDRP;
pDetails.swpInitial.ulReserved1      = 0;
pDetails.swpInitial.ulReserved2      = 0;

WinStartApp(hwndDRP, &pDetails, pgmInputs, NULL, 1);

return(0);
}




void strdelc(char *s, char c)
{
while ( *s )
   {
   if ( *s == c )
      strcpy( s, s+1 );
   else
      s++;
   }
}



INT strndel(CHAR *s, INT n)
{
INT len;

len = strlen(s);
if( len < n )
   return(0);
strcpy(s, s+n);
return(1);
}





INT chkreg(VOID)
{
if(strlen(sprc) == 13)
   {
   if( stricmp(sprc, ",,...........") == 0 || stricmp(sprc, ".......==zz==") == 0 || stricmp(sprc, "...=======...") == 0 )
      return(1);
   else
      return(0);
   }
else
   return(0);
}



VOID _Optlink payUp(PVOID n)
{
HAB habT;
HMQ hmqT;
HWND hwndDlg, hwndL;

habT = WinInitialize(0);
hmqT = WinCreateMsgQueue(habT, 0);
WinCancelShutdown(hmqT, TRUE);


TUSE++;
if( !chkreg() )
   {
   DosSleep(3000);
   hwndL = WinLoadDlg(HWND_DESKTOP,
                               HWND_DESKTOP,
	                     aboutProc,
	                     hResource,
	                     ID_ABOUTZIPZAP,
	                     NULL);

   WinProcessDlg(hwndL);
   TUSE = 0;
   }


WinDestroyMsgQueue(hmqT);
WinTerminate(habT);
_endthread();
}



INT setINI(VOID)
{

if( CHECKMOD )
   {
   PrfQueryProfileString(HINI_USERPROFILE,
                               "ZipZapIsInstalled",
                               "InstallationPath",
                               "", ZIPZAPINI, ZZMAXPATH);
   PrfQueryProfileString(HINI_USERPROFILE,
                               "ZipZapIsInstalled",
                               "rc",
  	                     "", sprcTMP, ZZMAXPATH);
   strcpy(INSTALLDIR, ZIPZAPINI);	
   strcpy(ZIPZAPINIFN, ZIPZAPINI);	
   if( ZIPZAPINIFN[strlen(ZIPZAPINIFN) - 1] != '\\' )
      strcat(ZIPZAPINIFN, "\\");
   strcat(ZIPZAPINIFN, "ZIPZAP.INI");
   if( strlen(sprcTMP) > 0 )
      {
      queryZZSet();
      strcpy(sprc, sprcTMP);	
      PrfWriteProfileString(HINI_USERPROFILE, "ZipZapIsInstalled", "rc", "");
      saveZZSet();
      }
   CHECKMOD = FALSE;
   }
   			
if( strlen(ZIPZAPINI) == 0 )
   {
   getINIFQNAME();
   PrfWriteProfileString(HINI_USERPROFILE,
                              "ZipZapIsInstalled",
                              "InstallationPath",
                              ZIPZAPINIFN);
   }

return(0);
}



VOID getINIFQNAME(VOID)
{
APIRET rc;
CHAR fqprogPath[ZZMAXPATH];

rc = DosQueryModuleName(hResource,  sizeof(fqprogPath), fqprogPath);
if( rc == 0 )
   {
   INT num, mark;

   strcpy(progPath, fqprogPath);
   mark = -1;
   for( num=0;num<strlen(fqprogPath);num++ )
      {
      if( fqprogPath[num] == '\\' )
         mark = num;
      }
   if( mark )
      progPath[mark] = '\0';
   }
strcpy(ZIPZAPINIFN, progPath);
if( strlen(ZIPZAPINIFN) > 1 )
   {
   if( ZIPZAPINIFN[strlen(ZIPZAPINIFN) - 1] != '\\' )
      strcat(ZIPZAPINIFN, "\\");
   strcat(ZIPZAPINIFN, "ZIPZAP.INI");
   }
}



VOID msgBox(HWND hwnd, CHAR *title, CHAR *message)
{
WinMessageBox(HWND_DESKTOP,
                     hwnd,
                     message,
                     title,
                     0,
                     MB_OK | MB_ICONEXCLAMATION );
}





INT msgBoxOKCANCEL(HWND hwndDlg, CHAR *title, CHAR *msg)
{
if ( WinMessageBox(HWND_DESKTOP,
                          hwndDlg,
                          msg,
                          title,
                          0,
                          MB_ICONEXCLAMATION | MB_OKCANCEL) == MBID_CANCEL )
   {
   return(0);
   }
else
   return(1);
}


















VOID msgOK(CHAR *title, CHAR *message)
{
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              message,
              title,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}


VOID debugMsgStr(CHAR *str, CHAR *varName)
{
CHAR dMsg[255] = "Debug Message string ... ";
CHAR tmp[ZZMAXPATH];

strcat(dMsg, varName),
strcpy(tmp, "\"");
strcat(tmp, str);
strcat(tmp, "\"");
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              tmp,
              dMsg,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}




VOID debugMsgInt(INT num, CHAR *varName)
{
CHAR str[255] = "";
CHAR dMsg[255] = "Debug Message Int ... ";

strcat(dMsg, varName),
itoa(num, str, 10);
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              str,
              dMsg,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}




VOID debugMsgULong(ULONG num, CHAR *varName)
{
CHAR str[255] = "";
CHAR dMsg[255] = "Debug Message ULong ... ";

strcat(dMsg, varName),
ultoa(num, str, 10);
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              str,
              dMsg,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}




VOID debugMsgLong(LONG num, CHAR *varName)
{
CHAR str[255] = "";
CHAR dMsg[255] = "Debug Message Long ... ";

strcat(dMsg, varName),
ltoa(num, str, 10);
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              str,
              dMsg,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}




VOID debugMsgCH(CHAR ch, CHAR *varName)
{
CHAR str[255] = "";
CHAR dMsg[255] = "Debug Message char ... ";

strcat(dMsg, varName),
str[0] = ch;
str[1] = '\0';
WinMessageBox(HWND_DESKTOP,
              HWND_DESKTOP,
              str,
              dMsg,
              0,
              MB_OK | MB_ICONEXCLAMATION );
}

